# 插件个人信息页面修复说明

## 问题描述

当插件已经登录后，点击个人信息跳转到个人信息页面时显示未登录。

## 问题原因

1. **前端缺少路由**：插件打开的是 `/user/profile` 路径，但前端 `App.tsx` 中没有这个路由配置
2. **认证状态隔离**：插件登录后 token 保存在插件的 `globalState` 中，但浏览器的 `localStorage` 是空的，导致前端认为用户未登录
3. **路由保护时机问题**：`ProtectedRoute` 在页面组件处理 token 之前就检查认证状态，导致直接重定向到登录页
4. **Token 过期问题**：如果插件中的 token 已过期，前端会拒绝使用该 token

## 解决方案

### 1. 创建个人信息页面

创建了 `UserProfilePage.tsx` 页面，展示用户的详细信息：
- 用户名、邮箱
- 部门、工号
- 角色、注册时间、更新时间
- 头像显示
- 修改密码按钮

**文件位置**：`spec-share-frontend/src/pages/UserProfilePage.tsx`

### 2. 添加路由配置（不使用 ProtectedRoute）

在 `App.tsx` 中添加了 `/user/profile` 路由，**关键点：不使用 `ProtectedRoute` 包裹**：

```typescript
<Route 
  path="/user/profile" 
  element={<UserProfilePage />}
/>
```

**为什么不使用 ProtectedRoute？**
- `ProtectedRoute` 会在组件加载前检查认证状态
- 此时 token 还在 URL 参数中未被处理
- 会导致页面立即重定向到登录页
- `UserProfilePage` 需要先处理 token 再检查认证状态

**文件位置**：`spec-share-frontend/src/App.tsx`

### 3. 修改插件命令

修改了 `openUserCenterCommand` 命令，在打开 URL 时携带 token 参数，并增加 token 有效性检查：

```typescript
// 检查 token 是否已过期
if (JWTParser.isExpired(token)) {
    vscode.window.showWarningMessage('登录已过期，请重新登录');
    return;
}

// 检查 token 是否即将过期（5分钟内）
if (JWTParser.isAboutToExpire(token)) {
    const remainingMinutes = Math.floor(JWTParser.getRemainingTime(token) / 60000);
    vscode.window.showWarningMessage(`登录即将过期（剩余 ${remainingMinutes} 分钟），建议重新登录`);
}

// JWT token 使用 Base64URL 编码，在 URL 查询参数中是安全的，不需要额外编码
const userCenterUrl = `${baseUrl}?token=${token}`;
```

**重要改进**：
- 在打开页面前检查 token 是否已过期，如果过期则提示用户重新登录
- 如果 token 即将过期（5分钟内），也会给出警告提示
- JWT token 使用 Base64URL 编码（只包含 `a-z, A-Z, 0-9, -, _, =`），这些字符在 URL 查询参数中都是安全的，不需要使用 `encodeURIComponent` 编码

**文件位置**：`cursor-helper/src/commands/openUserCenter.ts`

### 4. 自动登录功能

在 `UserProfilePage` 中添加了从 URL 参数获取 token 并自动登录的逻辑：

**关键改进**：
- 使用 `useRef` 防止 token 被重复处理
- 分离 token 处理和认证检查的 `useEffect`
- 使用 `replace: true` 避免在浏览器历史记录中保留带 token 的 URL
- 添加详细的日志输出方便调试

```typescript
const hasProcessedToken = useRef(false);

useEffect(() => {
  const token = searchParams.get('token');
  
  if (token && !hasProcessedToken.current) {
    hasProcessedToken.current = true;
    setIsProcessingToken(true);
    
    try {
      login(token);
      // 清除 URL 中的 token 参数
      const newSearchParams = new URLSearchParams(searchParams);
      newSearchParams.delete('token');
      setSearchParams(newSearchParams, { replace: true });
      message.success('登录成功');
    } catch (error) {
      message.error('登录失败，token 无效');
      navigate('/login', { replace: true });
    } finally {
      setIsProcessingToken(false);
    }
  }
}, [searchParams, login, setSearchParams, navigate]);

// 第二个 useEffect：在 token 处理完成后检查认证状态
useEffect(() => {
  const token = searchParams.get('token');
  if (!token && !isProcessingToken && !loading && !isAuthenticated) {
    message.warning('请先登录');
    navigate('/login', { replace: true });
  }
}, [searchParams, isProcessingToken, loading, isAuthenticated, navigate]);
```

这样可以实现：
1. 插件打开个人信息页面时，自动将 token 传递给浏览器
2. 页面加载时检测 URL 中的 token
3. 使用 token 调用 `login()` 方法
4. 登录成功后立即清除 URL 中的 token（使用 `replace` 避免历史记录）
5. 如果没有 token 且未登录，则跳转到登录页

## 测试步骤

1. **确保插件已登录且 token 未过期**（重要！）
2. 点击"个人信息"按钮
3. 浏览器应该自动打开个人信息页面并显示用户信息，不会显示"未登录"
4. URL 中的 token 参数会被自动清除

## 常见问题

### Q: 点击"个人信息"后跳转到登录页，显示"登录已过期"
**A**: 这说明插件中保存的 token 已过期。解决方法：
1. 在插件中重新登录
2. Token 默认有效期为 24 小时
3. 可以在后端配置文件或环境变量中设置 `JWT_EXPIRATION_HOURS` 来调整有效期

### Q: 提示"登录即将过期"
**A**: Token 在 5 分钟内即将过期，建议重新登录以获取新的 token。

### Q: Token 中没有 username 或 id 字段
**A**: 前端的 `parseToken` 函数已经优化，会从 email 中提取用户名（`@` 前面的部分）作为 username。

## 调试说明

如果遇到问题，可以在浏览器控制台查看以下日志：
- `Processing token from URL...` - 表示正在处理 token
- `Token login failed:` - 表示 token 登录失败

## 安全说明

- Token 在 URL 中传递后会立即被清除
- 使用 `replace: true` 避免在浏览器历史记录中保留带 token 的 URL
- JWT token 使用 Base64URL 编码，直接在 URL 中传递是安全的（不需要额外编码）
- 页面内部实现了认证检查，未登录用户会被重定向到登录页

## 技术要点

1. **路由保护时机**：`/user/profile` 不能使用 `ProtectedRoute`，因为它会在 token 处理前就检查认证状态
2. **避免重复处理**：使用 `useRef` 确保 token 只被处理一次
3. **useEffect 分离**：token 处理和认证检查使用两个独立的 `useEffect`
4. **URL 历史记录**：使用 `replace: true` 避免保留带 token 的 URL

## 相关文件

### 前端（spec-share-frontend）
- `src/pages/UserProfilePage.tsx` - 新建：个人信息页面，支持 token 自动登录
- `src/App.tsx` - 修改：添加 `/user/profile` 路由（不使用 ProtectedRoute）

### 插件（cursor-helper）
- `src/commands/openUserCenter.ts` - 修改：携带 token 参数打开页面
- `src/utils/config.ts` - 已存在，提供配置管理功能
