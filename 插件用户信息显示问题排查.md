# 插件用户信息显示问题排查

## 问题描述

插件中显示的用户名和头像不正确，可能显示的是旧数据。

## 可能的原因

1. **缓存的旧数据**
   - WorkspaceState 中缓存了旧的用户信息
   - 旧数据可能是从 JWT 解析的（只有基本信息）

2. **初始化顺序问题**
   - 插件启动时从缓存读取
   - Profile API 调用是异步的，可能还没完成

3. **头像路径问题**
   - Base64 头像可能解析失败
   - 缓存的头像文件可能损坏

## 解决方案

### 1. 清除旧缓存（推荐）

**方法 A：通过插件命令**
1. 在 VS Code 中按 `Ctrl+Shift+P`
2. 执行 "Cursor Assistant: Logout"
3. 重新登录

**方法 B：手动清除**
1. 关闭 VS Code
2. 删除缓存目录（取决于操作系统）：
   - Windows: `%APPDATA%\Code\User\globalStorage\your-extension-id\`
   - macOS: `~/Library/Application Support/Code/User/globalStorage/your-extension-id/`
   - Linux: `~/.config/Code/User/globalStorage/your-extension-id/`
3. 重新打开 VS Code
4. 重新登录

### 2. 强制刷新用户信息

**已修复：** 在 `extension.ts` 中添加了强制刷新逻辑

```typescript
// 初始化时如果有 token，强制从 API 刷新
const token = await authService.getTokenManager().getValidToken();
if (token) {
    Logger.info('Valid token found, fetching user profile from API...');
    await profileSvc.refreshProfile(); // 强制刷新
}
```

### 3. 检查日志

打开输出面板查看日志：

**应该看到的正确日志：**

```
[INFO] Valid token found, fetching user profile from API...
[INFO] Fetching user profile from Profile API...
[INFO] User profile fetched successfully: user@example.com
[INFO]   - Username: Howell
[INFO]   - Department: 中央研究院
[INFO]   - Employee ID: 17868
[INFO]   - Avatar: Base64
[INFO] Loading avatar for user@example.com, avatarUrl: Base64
[INFO] Processing Base64 avatar for user@example.com
[INFO] Base64 avatar cached for user@example.com
[INFO] User info refreshed successfully
[INFO] UserInfoTreeDataProvider refreshed
```

**如果看到旧的日志（错误）：**

```
[INFO] Valid token found, loading user profile...
[INFO] Using cached profile  ← 使用了旧缓存
[INFO] Using default avatar  ← 头像加载失败
```

## 调试步骤

### 步骤 1：检查当前用户信息

在输出面板（Output）中查看：
1. View > Output
2. 选择 "Cursor Assistant"
3. 查找最近的用户信息日志

### 步骤 2：手动刷新

1. 按 `Ctrl+Shift+P`
2. 执行 "Cursor Assistant: Refresh User Info"
3. 查看输出日志

### 步骤 3：重新登录

1. 执行 "Cursor Assistant: Logout"
2. 执行 "Cursor Assistant: Login"
3. 登录成功后，检查 TreeView 显示

### 步骤 4：检查 API 响应

如果问题仍然存在，检查 Profile API 是否正常：

**在浏览器中测试：**

1. 获取 Token（从输出日志中复制，或从设置中查看）
2. 在浏览器控制台执行：

```javascript
fetch('https://spec.pixvert.app/api/v1/users/me/profile', {
  headers: {
    'Authorization': 'Bearer YOUR_TOKEN_HERE'
  }
})
.then(r => r.json())
.then(data => console.log(data));
```

3. 检查返回的数据：

```json
{
  "id": "user-id",
  "username": "Howell",  ← 应该是正确的用户名
  "email": "user@example.com",
  "avatar_url": "data:image/png;base64,...",  ← 应该有头像
  "department": "中央研究院",
  "employee_id": "17868",
  "role": "admin"
}
```

## 代码修改

### extension.ts

**修改前（使用缓存）：**
```typescript
const profile = await profileSvc.getProfile(); // 可能获取旧缓存
```

**修改后（强制刷新）：**
```typescript
if (token) {
    await profileSvc.refreshProfile(); // 强制从 API 刷新
}
const profile = await profileSvc.getProfile();
```

### userProfileService.ts

**关键方法：**

```typescript
async fetchProfile(): Promise<UserProfile | null> {
    // 调用 GET /api/v1/users/me/profile
    const response = await this.apiClient.get<any>(profileUrl);
    
    const profile: UserProfile = {
        email: data.email,
        nickname: data.username,  // 从 API 获取正确的用户名
        avatarUrl: data.avatar_url, // 从 API 获取头像（Base64）
        department: data.department,
        employeeId: data.employee_id,
        role: data.role,
        lastSyncedAt: Date.now()
    };
    
    return profile;
}
```

## 重新编译和测试

### 1. 编译插件

```bash
cd f:\spec-kit\cursor-helper
npm run compile
```

### 2. 重新加载窗口

- 按 `F1`
- 执行 "Developer: Reload Window"

### 3. 验证

1. 打开 TreeView "CURSOR ASSISTANT"
2. 查看用户信息：
   - ✅ 用户名应该正确（如 "Howell"）
   - ✅ 邮箱应该正确
   - ✅ 头像应该显示（不是默认头像）

## 常见问题

### Q: 为什么显示 "jianghongwei" 而不是 "Howell"?

A: 这是从旧的 JWT Token 解析的邮箱本地部分。清除缓存并重新登录即可。

### Q: 为什么头像显示不正确？

A: 可能的原因：
1. Base64 头像解析失败 → 查看日志
2. 缓存的头像文件损坏 → 清除缓存
3. Profile API 没有返回头像 → 检查 API 响应

### Q: 如何确认是否使用了 Profile API？

A: 在输出日志中查找：
```
[INFO] Fetching user profile from Profile API...
[INFO] User profile fetched successfully: ...
```

如果没有这些日志，说明：
1. Token 无效或过期
2. API 调用失败
3. 仍在使用旧缓存

## 预期行为

**正确的流程：**

```
插件启动
  ↓
检查 Token 是否存在
  ↓
Token 存在 → 调用 Profile API
  ↓
GET /api/v1/users/me/profile
  ↓
获取完整信息：
  - username: "Howell"
  - avatar_url: "data:image/png;base64,..."
  ↓
解析 Base64 头像并缓存
  ↓
刷新 TreeView
  ↓
✅ 显示正确的用户名和头像
```

## 文件清单

### 已修改
- ✅ `src/extension.ts` - 强制刷新用户信息
- ✅ `src/services/userProfileService.ts` - 调用 Profile API
- ✅ `src/utils/avatarLoader.ts` - 支持 Base64 头像

---

**创建时间：** 2026-01-19
**问题类型：** 缓存同步问题
**状态：** 已修复，需要清除旧缓存并重新登录
