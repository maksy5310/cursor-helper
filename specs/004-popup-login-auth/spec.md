# Feature Specification: 弹出登录页面鉴权

**Feature Branch**: `004-popup-login-auth`  
**Created**: 2026-01-04  
**Status**: Draft  
**Input**: User description: "增加登陆鉴权功能。采用熟悉的弹出登陆页面进行鉴权方式，取消原来的直接输入token鉴权。 相关的前端工程在 spec-share-fontend ，后端工程在spec-share-server 。"

## Clarifications

### Session 2026-01-04

- Q: 登录流程的具体交互方式 → A: 未登录时，默认插件面板显示登录按钮。点击登录，弹出登录页面。登录完成后，才会显示插件原来的会话列表。登录后提供退出按钮或下拉菜单可供登出。

## User Scenarios & Testing

### User Story 1 - 未登录时显示登录按钮 (Priority: P1)

当用户未登录时，插件面板默认显示登录按钮，用户点击登录按钮后弹出登录页面（模态框），用户可以在弹窗中完成登录。

**Why this priority**: 这是新认证方式的核心功能。在插件面板中显示登录按钮提供了清晰的登录入口，用户点击后弹出登录页面，无需跳转到其他页面即可完成登录，这是MVP的基础功能。

**Independent Test**: 可以通过清除认证信息，打开插件面板，验证面板是否显示登录按钮，点击按钮后是否弹出登录页面，用户输入正确的用户名和密码后能够成功登录。即使没有其他功能，登录按钮和弹出登录功能本身也能提供价值（用户认证）。

**Acceptance Scenarios**:

1. **Given** 用户未登录（没有有效的认证token），**When** 用户打开插件面板，**Then** 插件面板显示登录按钮，不显示会话列表
2. **Given** 用户在插件面板中看到登录按钮，**When** 用户点击登录按钮，**Then** 系统弹出登录页面（模态框），显示在当前页面之上
3. **Given** 用户在弹出登录页面中输入正确的用户名（邮箱）和密码，**When** 用户提交登录表单，**Then** 系统验证凭据成功，保存认证token，关闭登录弹窗，插件面板显示会话列表
4. **Given** 用户在弹出登录页面中输入错误的用户名或密码，**When** 用户提交登录表单，**Then** 系统显示错误提示信息，登录弹窗保持打开状态，不允许登录
5. **Given** 用户在弹出登录页面中，**When** 用户点击弹窗外部区域或关闭按钮，**Then** 系统关闭登录弹窗，插件面板仍显示登录按钮（保持未登录状态）

---

### User Story 2 - 登录后显示会话列表 (Priority: P1)

用户登录成功后，插件面板自动显示原来的会话列表，用户可以查看和管理会话。

**Why this priority**: 登录后显示会话列表是插件的核心功能。用户登录的目的就是为了访问会话列表，这是登录流程的完整闭环，与登录功能同等重要。

**Independent Test**: 可以通过用户完成登录后，验证插件面板是否自动从显示登录按钮切换为显示会话列表，用户可以正常查看和管理会话。即使没有登出功能，显示会话列表功能本身也能提供价值（核心功能访问）。

**Acceptance Scenarios**:

1. **Given** 用户已成功登录，**When** 登录弹窗关闭后，**Then** 插件面板自动从显示登录按钮切换为显示会话列表
2. **Given** 用户已登录，**When** 用户打开插件面板，**Then** 插件面板显示会话列表，不显示登录按钮
3. **Given** 用户已登录，**When** 用户刷新或重新打开插件面板，**Then** 插件面板继续显示会话列表（使用保存的认证信息）

---

### User Story 3 - 用户登出功能 (Priority: P2)

用户登录后，可以通过退出按钮或下拉菜单登出，登出后插件面板恢复显示登录按钮。

**Why this priority**: 登出功能是认证流程的重要组成部分，允许用户安全地结束会话。依赖于登录功能，但可以独立实现和测试。

**Independent Test**: 可以通过已登录用户，点击退出按钮或下拉菜单中的登出选项，验证系统是否清除认证信息，插件面板是否恢复显示登录按钮。即使没有其他功能，登出功能本身也能提供价值（会话管理）。

**Acceptance Scenarios**:

1. **Given** 用户已登录，**When** 用户点击退出按钮或下拉菜单中的登出选项，**Then** 系统清除认证token，插件面板从显示会话列表切换为显示登录按钮
2. **Given** 用户已登出，**When** 用户尝试访问需要认证的功能，**Then** 插件面板显示登录按钮，不显示会话列表
3. **Given** 用户已登出，**When** 用户刷新或重新打开插件面板，**Then** 插件面板继续显示登录按钮（认证信息已清除）

---

### User Story 4 - 移除手动输入Token功能 (Priority: P1)

系统移除原有的手动输入JWT token的认证方式，所有认证必须通过弹出登录页面完成。

**Why this priority**: 这是功能迁移的核心要求。移除旧的token输入方式确保所有用户使用统一的登录流程，提高安全性和用户体验的一致性。

**Independent Test**: 可以通过清除认证信息，尝试访问需要认证的功能，验证系统不再显示token输入界面，而是弹出登录页面。即使没有弹出登录功能，移除token输入功能本身也能提供价值（统一认证方式）。

**Acceptance Scenarios**:

1. **Given** 用户未登录，**When** 用户尝试访问需要认证的功能，**Then** 系统不再显示手动输入token的界面，而是弹出登录页面
2. **Given** 用户之前保存了token，**When** 系统启动或用户访问应用，**Then** 系统不再使用保存的token进行认证，要求用户通过弹出登录页面重新登录
3. **Given** 用户尝试通过其他方式（如直接设置token）绕过登录，**When** 系统检测到认证请求，**Then** 系统要求用户通过弹出登录页面完成认证

---

### User Story 5 - 登录状态保持和自动检测 (Priority: P2)

用户登录成功后，系统保持登录状态，在后续访问中自动使用保存的认证信息，无需重复登录。

**Why this priority**: 登录状态保持是用户体验的重要功能，避免用户每次访问都需要重新登录。依赖于登录功能，但可以独立实现和测试。

**Independent Test**: 可以通过用户完成登录后，刷新页面或访问其他需要认证的页面，验证系统是否自动使用保存的认证信息，用户无需重新登录。即使没有其他功能，登录状态保持功能本身也能提供价值（用户体验）。

**Acceptance Scenarios**:

1. **Given** 用户已成功登录，**When** 用户刷新页面或访问其他需要认证的页面，**Then** 系统自动使用保存的认证信息，不弹出登录页面，正常显示内容
2. **Given** 用户的认证token已过期，**When** 用户尝试访问需要认证的功能，**Then** 系统检测到token过期，自动弹出登录页面，要求用户重新登录
3. **Given** 用户已登录，**When** 用户主动退出登录，**Then** 系统清除认证信息，后续访问需要认证的功能时弹出登录页面

---

### Edge Cases

- 当用户在登录过程中（正在输入凭证）时，如果token突然失效，系统应如何处理？应保持登录弹窗打开，允许用户完成登录
- 当用户同时打开多个标签页，在一个标签页中登录后，其他标签页应如何处理？应检测到登录状态变化，自动更新为已登录状态，或提示用户刷新页面
- 当网络错误导致登录请求失败时，系统应如何处理？应显示网络错误提示，保持登录弹窗打开，允许用户重试
- 当用户输入错误的凭据多次后，系统应如何处理？应显示错误提示，可以考虑添加验证码或临时锁定机制（但不在本功能范围内）
- 当弹出登录页面显示时，用户按ESC键应如何处理？应关闭登录弹窗，但用户仍无法访问需要认证的功能

## Requirements

### Functional Requirements

- **FR-001**: 系统必须在用户未登录时，插件面板默认显示登录按钮，不显示会话列表
- **FR-002**: 系统必须允许用户通过点击登录按钮打开弹出登录页面（模态框）
- **FR-003**: 系统必须提供弹出登录页面，包含用户名（邮箱）和密码输入字段
- **FR-004**: 系统必须通过弹出登录页面调用后端登录API进行用户认证
- **FR-005**: 系统必须在登录成功后保存认证token，关闭登录弹窗，插件面板从显示登录按钮切换为显示会话列表
- **FR-006**: 系统必须在登录失败时显示错误提示信息，保持登录弹窗打开
- **FR-007**: 系统必须在用户已登录时，插件面板显示会话列表，不显示登录按钮
- **FR-008**: 系统必须提供退出按钮或下拉菜单，允许用户登出
- **FR-009**: 系统必须在用户登出后清除认证token，插件面板从显示会话列表切换为显示登录按钮
- **FR-010**: 系统必须移除所有手动输入JWT token的界面和功能
- **FR-011**: 系统必须不再使用本地存储的旧token进行自动认证
- **FR-012**: 系统必须在用户登录成功后保持登录状态，在后续访问中自动使用保存的认证信息
- **FR-013**: 系统必须在检测到认证token过期时，插件面板恢复显示登录按钮，要求用户重新登录
- **FR-014**: 系统必须允许用户关闭登录弹窗（通过点击外部区域、关闭按钮或ESC键），但关闭后插件面板仍显示登录按钮（保持未登录状态）

### Key Entities

- **插件面板**: Cursor插件的侧边栏面板，用于显示会话列表或登录按钮
- **登录按钮**: 插件面板中显示的按钮，用户点击后弹出登录页面
- **弹出登录页面**: 以模态框形式显示的登录界面，包含用户名（邮箱）和密码输入字段，显示在当前页面之上，不进行页面跳转
- **会话列表**: 插件面板中显示的会话记录列表，用户登录后才能查看
- **退出按钮/下拉菜单**: 用户登录后显示的登出选项，允许用户结束会话
- **认证token**: 用户登录成功后由后端返回的认证令牌，用于后续API请求的身份验证
- **登录状态**: 基于有效的认证token判断的用户认证状态，决定插件面板显示登录按钮还是会话列表

## Success Criteria

### Measurable Outcomes

- **SC-001**: 100%的未登录用户打开插件面板时显示登录按钮，不显示会话列表
- **SC-002**: 用户点击登录按钮后，100%的情况下弹出登录页面（无遗漏的触发场景）
- **SC-003**: 用户可以在弹出登录页面中完成登录，从打开弹窗到登录成功的平均时间不超过30秒
- **SC-004**: 登录成功后，100%的情况下插件面板自动从显示登录按钮切换为显示会话列表，无需额外步骤
- **SC-005**: 系统完全移除手动输入token的功能，0%的用户能够通过旧方式（手动输入token）进行认证
- **SC-006**: 登录状态保持功能正常工作，用户在登录后的同一会话中，95%的情况下无需重复登录即可查看会话列表
- **SC-007**: 当认证token过期时，系统在5秒内检测到，插件面板恢复显示登录按钮
- **SC-008**: 弹出登录页面的显示和关闭操作响应时间在200毫秒内，用户感知流畅
- **SC-009**: 用户登出后，100%的情况下插件面板从显示会话列表切换为显示登录按钮

## Assumptions

- 后端已实现用户登录API接口（邮箱和密码认证）
- 后端登录API返回有效的JWT token用于后续认证
- 插件面板已存在，可以显示会话列表或登录按钮
- Cursor插件支持模态框/弹窗显示功能
- 系统已有API客户端基础设施，可以调用后端登录API
- 系统已有错误处理机制，可以显示登录错误信息
- 用户熟悉标准的登录流程（输入用户名和密码）

## Dependencies

- 后端用户认证API（spec-share-server中的登录接口）
- 插件面板UI组件（显示登录按钮、会话列表）
- Token管理和存储机制
- API客户端和错误处理基础设施

## Out of Scope

- 用户注册功能（应在其他功能中实现）
- 忘记密码功能（应在其他功能中实现）
- 密码修改功能（应在其他功能中实现）
- 多因素认证（MFA）
- 单点登录（SSO）
- 社交登录（OAuth、第三方登录）
- 登录页面的具体UI设计细节（样式、布局等，但需要是弹出形式）
- 用户管理功能
- 登录日志和审计功能

