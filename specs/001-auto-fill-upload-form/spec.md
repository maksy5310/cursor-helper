# Feature Specification: 上传表单自动填充

**Feature Branch**: `001-auto-fill-upload-form`  
**Created**: 2026-01-14  
**Status**: Draft  
**Input**: User description: "上传记录的时候,表单中的邮箱自动填充当前登录账号的邮箱。项目名单自动填充当前工程名称。"

## Clarifications

### Session 2026-01-14 (第一轮 - 已废弃,改用简化的JWT认证)

~~- Q: 未授权场景的处理机制 - 当服务端返回401未授权错误时的处理方式 → A: 自动弹出登录界面,引导用户重新登录获取新令牌~~
~~- Q: 令牌刷新机制的实现策略 - 令牌刷新的触发时机和策略 → A: 在令牌到期前自动刷新(如过期前5分钟)+检测到401时也尝试刷新~~
~~- Q: 刷新令牌失败后的降级策略 - 当自动刷新令牌失败时系统应如何处理 → A: 清除当前令牌并弹出登录界面,要求用户重新登录~~
~~- Q: 登录界面的展现形式 - 在VSCode扩展环境中弹出登录界面的展现方式 → A: 在系统默认浏览器中打开登录页面,完成后回调扩展~~
~~- Q: 令牌存储的安全级别 - 访问令牌和刷新令牌的存储机制 → A: 使用VSCode的SecretStorage API存储(系统级加密)~~
~~- Q: 个人信息区域的展示内容 - 在会话列表上方应显示哪些用户信息 → A: 显示用户头像、昵称/用户名、邮箱地址~~
~~- Q: 未登录状态下的UI展示 - 当用户未登录时个人信息区域如何展示 → A: 显示默认头像图标+文字"未登录"+登录按钮~~
~~- Q: 用户信息的更新时机 - 个人信息区域何时更新显示内容 → A: 在扩展激活时、登录成功后、令牌刷新后自动更新,并提供手动刷新选项~~
~~- Q: 个人信息区域的交互行为 - 用户点击个人信息区域应触发什么行为 → A: 退出登录提供单独按钮,点击个人信息区域打开浏览器跳转到个人中心页面~~
~~- Q: 用户头像的获取和显示策略 - 用户头像从何处获取及降级方案 → A: 优先使用后端API返回的头像URL,失败则使用Gravatar,最后降级到本地默认头像~~

### Session 2026-01-15 (正确的JWT认证方案)

- Q: 用户身份认证机制 → A: 使用spec-share-server现有的JWT令牌认证(前端登录页获取JWT,插件直接使用)
- Q: JWT令牌的获取方式 → A: 用户在浏览器打开登录页面,登录成功后通过URI回调(cursor://或vscode://)将JWT传回插件
- Q: JWT令牌刷新机制 → A: 后端只返回access token,不支持refresh token,过期后需要用户重新登录
- Q: 获取用户信息的方式 → A: 登录时从JWT payload中解析用户信息(email等)并缓存到本地
- Q: 个人信息区域的展示内容 - 在会话列表上方应显示哪些用户信息 → A: 显示用户头像、昵称/用户名、邮箱地址
- Q: 未登录状态下的UI展示 - 当用户未登录时个人信息区域如何展示 → A: 显示默认头像图标+文字"未登录"+登录按钮
- Q: 个人信息区域的交互行为 - 用户点击个人信息区域应触发什么行为 → A: 退出登录提供单独按钮,点击个人信息区域打开浏览器跳转到个人中心页面
- Q: 用户头像的获取和显示策略 - 用户头像从何处获取及降级方案 → A: 优先使用后端API返回的头像URL,失败则使用Gravatar,最后降级到本地默认头像

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 邮箱自动填充 (Priority: P1)

当用户打开上传记录表单时,系统自动将当前登录账号的邮箱地址填充到邮箱输入框中,用户无需手动输入邮箱信息即可继续完成表单提交。

**Why this priority**: 这是最基础且最常用的功能,每次上传记录都需要填写邮箱,自动填充可以显著减少用户输入时间和错误率,提升用户体验。

**Independent Test**: 可以通过登录系统后打开上传表单来独立测试,验证邮箱字段是否自动填充了当前用户的邮箱地址。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统, **When** 用户打开上传记录表单, **Then** 邮箱输入框自动填充为当前登录账号的邮箱地址
2. **Given** 用户已登录且邮箱字段已自动填充, **When** 用户修改邮箱地址, **Then** 系统允许用户修改并使用新的邮箱地址提交
3. **Given** 用户已登录但账号未设置邮箱, **When** 用户打开上传记录表单, **Then** 邮箱输入框保持为空,提示用户手动输入
4. **Given** 用户未登录或令牌已失效, **When** 系统尝试获取邮箱信息收到401响应, **Then** 在系统默认浏览器中自动打开登录页面,引导用户重新登录

---

### User Story 2 - 项目名称自动填充 (Priority: P1)

当用户打开上传记录表单时,系统自动将当前工程的名称填充到项目名称输入框中,用户无需手动选择或输入项目名称即可继续完成表单提交。

**Why this priority**: 用户通常在特定项目上下文中上传记录,自动填充当前项目名称可以避免用户选择错误的项目,减少操作步骤。

**Independent Test**: 可以通过在特定项目上下文中打开上传表单来独立测试,验证项目名称字段是否自动填充了当前工程名称。

**Acceptance Scenarios**:

1. **Given** 用户在某个项目上下文中操作, **When** 用户打开上传记录表单, **Then** 项目名称字段自动填充为当前工程名称
2. **Given** 用户在项目上下文中且项目名称已自动填充, **When** 用户修改项目名称, **Then** 系统允许用户修改并使用新的项目名称提交
3. **Given** 用户不在任何项目上下文中, **When** 用户打开上传记录表单, **Then** 项目名称字段保持为空或显示默认提示,要求用户手动选择

---

### User Story 3 - 表单重置后保持自动填充 (Priority: P2)

当用户在上传表单中点击重置按钮或清空表单后,系统重新自动填充邮箱和项目名称字段,保持用户体验的一致性。

**Why this priority**: 虽然不是核心功能,但提供了更好的用户体验,避免用户在重置表单后需要重新手动输入这些信息。

**Independent Test**: 可以通过打开表单、填写部分内容、点击重置按钮来独立测试,验证邮箱和项目名称是否重新自动填充。

**Acceptance Scenarios**:

1. **Given** 用户已打开上传表单且字段已自动填充, **When** 用户点击重置按钮, **Then** 邮箱和项目名称字段重新自动填充为当前用户邮箱和当前工程名称
2. **Given** 用户修改了自动填充的字段后点击重置, **When** 表单重置完成, **Then** 字段恢复为自动填充的原始值

---

### User Story 4 - 侧边栏个人信息显示 (Priority: P1)

在侧边栏面板的会话列表上方显示个人信息区域,展示当前登录用户的头像、昵称和邮箱,让用户随时了解当前登录状态和身份信息。

**Why this priority**: 这是用户身份识别和账号管理的核心入口,必须优先实现。用户需要清楚地知道当前登录的账号,并能快速访问个人中心或执行登录/退出操作。

**Independent Test**: 可以通过打开侧边栏面板来独立测试,验证个人信息区域是否正确显示用户信息。

**Acceptance Scenarios**:

1. **Given** 用户已登录, **When** 用户打开侧边栏面板, **Then** 在会话列表上方显示用户头像、昵称、邮箱地址和退出按钮
2. **Given** 用户未登录, **When** 用户打开侧边栏面板, **Then** 显示默认头像图标、"未登录"文字和登录按钮
3. **Given** 用户已登录并查看个人信息区域, **When** 用户点击个人信息区域, **Then** 在系统默认浏览器中打开个人中心页面
4. **Given** 用户已登录, **When** 用户点击退出按钮, **Then** 系统清除本地令牌,个人信息区域切换为未登录状态
5. **Given** 用户未登录, **When** 用户点击登录按钮, **Then** 在系统默认浏览器中打开登录页面
6. **Given** 用户头像URL无法加载, **When** 系统尝试获取头像, **Then** 依次尝试后端头像URL、Gravatar服务、本地默认头像
7. **Given** 用户JWT令牌已过期, **When** 用户尝试上传记录, **Then** 系统检测到401响应并在浏览器中打开登录页面

---

### Edge Cases

- 当用户账号的邮箱地址为空或未设置时,邮箱字段如何处理?
- 当用户不在任何项目上下文中(例如从全局导航进入上传页面)时,项目名称字段如何处理?
- 当用户在表单提交过程中切换了项目上下文,是否需要更新项目名称字段?
- 当用户账号邮箱地址在表单打开后被修改(例如在另一个标签页中修改),是否需要同步更新表单中的邮箱字段?
- 当用户手动修改了自动填充的字段后,如果刷新页面或重新打开表单,是否保留用户的修改还是重新自动填充?
- 当JWT访问令牌已过期,用户尝试上传时,系统如何提示用户重新登录?
- 当用户在浏览器完成登录后,cursor://或vscode://回调失败时,如何引导用户?
- 当JWT payload无法正确解析时(格式错误或缺少必要字段),系统如何处理?
- 当用户的头像URL无效或加载超时时,如何快速降级到Gravatar或默认头像?
- 当用户昵称为空或包含特殊字符时,个人信息区域如何显示?
- 当用户在侧边栏面板未打开时退出登录,下次打开面板时个人信息区域是否正确显示未登录状态?
- 当用户点击个人信息区域跳转到个人中心页面失败(如浏览器无法打开)时,如何提示用户?
- 当扩展激活时网络不可用,无法获取用户信息,个人信息区域如何处理?

## Requirements *(mandatory)*

### Functional Requirements

#### 自动填充功能
- **FR-001**: 系统必须在用户打开上传记录表单时,自动获取当前登录账号的邮箱地址
- **FR-002**: 系统必须在用户打开上传记录表单时,自动获取当前工程的名称
- **FR-003**: 系统必须将获取到的邮箱地址自动填充到表单的邮箱输入框中
- **FR-004**: 系统必须将获取到的项目名称自动填充到表单的项目名称输入框中
- **FR-005**: 系统必须允许用户修改自动填充的邮箱地址和项目名称
- **FR-006**: 当用户账号未设置邮箱时,系统必须保持邮箱字段为空,并允许用户手动输入
- **FR-007**: 当用户不在项目上下文中时,系统必须保持项目名称字段为空或显示提示信息,要求用户手动选择
- **FR-008**: 系统必须在表单重置后重新执行自动填充逻辑
- **FR-009**: 系统必须验证自动填充的邮箱地址格式是否有效
- **FR-010**: 系统必须在表单提交时使用用户最终确认的邮箱和项目名称(无论是自动填充的还是手动修改的)

#### 身份认证与令牌管理
- **FR-011**: 系统必须在检测到API返回401未授权响应时,自动在系统默认浏览器中打开登录页面
- **FR-012**: 系统必须使用VSCode的SecretStorage API安全存储JWT访问令牌
- **FR-013**: 系统必须提供URI回调机制(cursor://或vscode://),使浏览器登录完成后能将JWT令牌传回VSCode扩展
- **FR-014**: 系统必须从JWT payload中解析用户信息(email, role等)并缓存到本地
- **FR-015**: 系统必须在令牌过期后,引导用户重新登录(后端不支持refresh token)

#### 侧边栏个人信息显示
- **FR-016**: 系统必须在侧边栏面板的会话列表上方显示个人信息区域
- **FR-017**: 当用户已登录时,系统必须显示用户头像、昵称/用户名、邮箱地址和退出按钮
- **FR-018**: 当用户未登录时,系统必须显示默认头像图标、"未登录"文字和登录按钮
- **FR-019**: 系统必须在扩展激活时自动从JWT解析并显示用户信息
- **FR-020**: 系统必须在登录成功后立即更新个人信息区域显示
- **FR-021**: 当用户点击个人信息区域时,系统必须在默认浏览器中打开个人中心页面
- **FR-022**: 当用户点击退出按钮时,系统必须清除本地存储的令牌并将个人信息区域切换为未登录状态
- **FR-023**: 当用户点击登录按钮时,系统必须在默认浏览器中打开spec-share-frontend的插件登录页面
- **FR-024**: 系统必须按以下优先级获取用户头像:JWT/登录响应中的头像URL → Gravatar服务 → 本地默认头像
- **FR-025**: 系统必须处理头像加载失败的情况,确保在任何情况下都能显示有效的头像
- **FR-026**: 当用户昵称为空时,系统必须使用邮箱地址的本地部分作为显示名称

### Key Entities

- **用户账号(User Account)**: 包含用户的登录信息和个人资料,其中包括邮箱地址、昵称、头像URL等属性
- **项目/工程(Project)**: 代表用户当前正在操作的工程或项目,包含项目名称等基本信息
- **上传记录(Upload Record)**: 用户提交的上传记录,包含邮箱、项目名称等字段
- **表单会话(Form Session)**: 用户打开表单时的上下文信息,包括当前登录用户和当前项目上下文
- **JWT令牌(JWT Token)**: spec-share-server返回的JWT访问令牌,包含用户信息(email, role等)和过期时间,存储在VSCode SecretStorage中
- **个人信息区域(User Info Panel)**: 侧边栏面板顶部区域,显示当前登录用户的头像、昵称、邮箱,以及登录/退出按钮
- **用户头像(User Avatar)**: 用户的头像图片,可能来源于JWT/登录响应、Gravatar服务或本地默认图标

## Success Criteria *(mandatory)*

### Measurable Outcomes

#### 自动填充功能成效
- **SC-001**: 用户在上传记录时无需手动输入邮箱和项目名称,表单打开时这两个字段已自动填充完成
- **SC-002**: 自动填充功能的准确率达到100%,即填充的邮箱地址必须是当前登录用户的邮箱,填充的项目名称必须是当前工程名称
- **SC-003**: 用户完成上传记录表单的平均时间减少至少30%(相比需要手动输入邮箱和项目名称的情况)
- **SC-004**: 因邮箱或项目名称填写错误导致的表单提交失败率降低至少50%
- **SC-005**: 90%以上的用户在使用自动填充功能后,不需要修改邮箱和项目名称字段即可直接提交
- **SC-006**: 表单加载时间不因自动填充功能而增加超过100毫秒

#### 身份认证与令牌管理成效
- **SC-007**: JWT令牌存储在系统级加密存储(SecretStorage)中,安全审计通过率100%
- **SC-008**: 当JWT过期需要重新登录时,用户能在3次点击内完成登录流程并返回扩展
- **SC-009**: URI回调机制成功率达到99%以上,JWT能准确传回扩展

#### 侧边栏个人信息显示成效
- **SC-010**: 个人信息区域在扩展激活后500毫秒内完成首次加载和显示(从缓存的JWT解析)
- **SC-011**: 用户头像加载时间不超过1秒,降级到默认头像的时间不超过2秒
- **SC-012**: 登录状态变更后,个人信息区域立即(100毫秒内)更新UI状态
- **SC-013**: 点击个人信息区域跳转到个人中心的成功率达到99%以上
- **SC-014**: 用户能在侧边栏面板中一目了然地识别当前登录账号,无需额外操作

## Assumptions

- 假设系统能够识别当前登录用户并获取其邮箱地址
- 假设系统能够识别当前项目上下文并获取项目名称
- 假设用户的邮箱地址存储在用户账号信息中且格式有效
- 假设上传记录表单是在用户已登录的状态下访问的
- 假设项目名称是唯一标识符或用户可理解的显示名称
- 假设表单支持JavaScript以实现动态填充功能
- 假设用户的操作系统支持VSCode的SecretStorage API(Windows Credential Manager、macOS Keychain或Linux Secret Service)
- 假设用户的系统默认浏览器可以正常打开spec-share-frontend的插件登录页面
- 假设浏览器登录成功后能通过cursor://或vscode:// URI scheme回调扩展并传递JWT令牌
- 假设spec-share-server使用JWT格式的访问令牌,包含用户信息(email, role等)和过期时间(exp字段)
- 假设spec-share-server的登录API返回JWT令牌,插件可以解析其payload获取用户信息
- 假设spec-share-server当前不支持refresh token机制,JWT过期后需要重新登录
- 假设JWT payload中包含email字段,可用于Gravatar头像生成
- 假设Gravatar服务在大多数网络环境下可访问(但不强制依赖)
- 假设spec-share-frontend有独立的个人中心页面URL,可在浏览器中直接访问
- 假设侧边栏面板已有会话列表功能,个人信息区域可以作为独立组件添加在其上方

## Out of Scope

- 自动填充其他表单字段(除邮箱和项目名称外)
- 记住用户之前手动修改的邮箱或项目名称
- 支持多个邮箱地址的选择
- 支持跨项目的批量上传
- 邮箱地址的验证和认证(仅填充,不验证邮箱是否真实存在)
- 实现完整的OAuth 2.0授权码流程(使用spec-share-server现有的简单JWT认证)
- 支持多因素认证(MFA)的额外验证流程
- 实现refresh token自动刷新机制(后端不支持)
- 令牌的黑名单或撤销机制(假设由后端处理)
- 跨设备的令牌同步功能
- 在侧边栏面板内实现完整的个人资料编辑功能(仅跳转到Web端个人中心)
- 用户头像的上传和裁剪功能(在Web端个人中心实现)
- 个人信息区域的主题定制和布局调整
- 多账号切换功能(当前仅支持单一账号登录)