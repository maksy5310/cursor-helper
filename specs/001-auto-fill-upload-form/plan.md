# Implementation Plan: 上传表单自动填充

**Branch**: `001-auto-fill-upload-form` | **Date**: 2026-01-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-auto-fill-upload-form/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

实现VSCode扩展的上传表单自动填充功能,包括:
1. **邮箱自动填充**: 从JWT令牌解析当前用户邮箱并自动填充到上传表单
2. **项目名称自动填充**: 从VSCode工作区上下文获取当前项目名称并自动填充
3. **侧边栏个人信息显示**: 在会话列表上方显示用户头像、昵称、邮箱,支持登录/退出
4. **JWT认证集成**: 使用spec-share-server现有的JWT认证,通过浏览器登录+URI回调获取令牌

**技术方案**: 使用VSCode Extension API + JWT解析 + SecretStorage存储 + URI Handler回调,不实现OAuth 2.0或refresh token(后端不支持)

## Technical Context

**Language/Version**: TypeScript 5.0+ (编译目标 ES2020)
**Primary Dependencies**: VSCode Extension API ^1.74.0, jose (JWT解析), node-fetch
**Storage**: VSCode SecretStorage API (JWT令牌), WorkspaceState (用户信息缓存)
**Testing**: VSCode Extension Test Framework, Mocha
**Target Platform**: VSCode Desktop (Windows/macOS/Linux)
**Project Type**: 单一项目 (VSCode扩展)
**Performance Goals**: 表单自动填充<100ms, 个人信息区域加载<500ms, 头像加载<1s
**Constraints**: JWT过期后需重新登录(无refresh token), 离线时使用缓存的用户信息
**Scale/Scope**: 单用户插件, ~2000行新代码, 4个主要User Stories

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ PASS (No constitution file found - using VSCode extension best practices)

由于项目没有定义constitution.md,我们遵循VSCode扩展开发的industry best practices:
- **扩展激活性能**: activationEvents精确定义,避免不必要的激活
- **API使用规范**: 使用官方VSCode Extension API,避免private API
- **安全存储**: 敏感数据(JWT)使用SecretStorage而非普通存储
- **用户体验**: 避免阻塞UI线程,异步操作使用Progress API
- **向后兼容**: 支持最低VSCode 1.74.0版本

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── models/
│   ├── userProfile.ts          # 新增: 用户资料数据模型
│   ├── auth.ts                 # 现有文件,需扩展JWT相关类型
│   └── uploadRecord.ts         # 现有文件
├── services/
│   ├── authService.ts          # 现有文件,需简化(移除OAuth,保留JWT)
│   ├── userProfileService.ts   # 新增: 用户资料管理服务
│   └── uploadService.ts        # 现有文件
├── utils/
│   ├── tokenManager.ts         # 现有文件,需简化(移除refresh token)
│   ├── jwtParser.ts            # 新增: JWT payload解析工具
│   ├── avatarLoader.ts         # 新增: 头像加载器(三级降级)
│   ├── uriHandler.ts           # 现有文件,需更新为JWT回调
│   └── workspaceHelper.ts      # 现有文件,获取项目名称
├── ui/
│   ├── uploadFormPanel.ts      # 现有文件,需集成自动填充
│   ├── userInfoTreeItem.ts     # 新增: 个人信息TreeView组件
│   └── sessionListPanel.ts     # 现有文件
├── commands/
│   ├── login.ts                # 现有文件,需简化
│   ├── logout.ts               # 新增: 登出命令
│   └── uploadRecord.ts         # 现有文件
└── extension.ts                # 现有文件,需注册新命令和TreeView

resources/
└── default-avatar.svg          # 新增: 默认头像资源

tests/
├── unit/
│   ├── jwtParser.test.ts       # 新增
│   ├── avatarLoader.test.ts    # 新增
│   └── userProfileService.test.ts  # 新增
└── integration/
    └── autoFill.test.ts        # 新增: 端到端自动填充测试
```

**Structure Decision**: 使用现有的单一项目结构(VSCode扩展标准布局),在现有模块中集成新功能,避免大规模重构。

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations** - 项目遵循VSCode扩展最佳实践,无需特殊复杂度justification。
---

## Phase 0: Outline & Research

**Status**: 鉁?Complete

**Output**: [research.md](./research.md)

**Key Decisions**:
1. **韬唤璁よ瘉**: 浣跨敤spec-share-server鐜版湁鐨凧WT璁よ瘉(鑰岄潪OAuth 2.0)
2. **浠ょ墝绠＄悊**: 鍗曚竴JWT璁块棶浠ょ墝,杩囨湡鍚庨噸鏂扮櫥褰?鏃爎efresh token)
3. **URI鍥炶皟**: cursor://鎴杤scode:// scheme鐢ㄤ簬娴忚鍣ㄥ洖璋?4. **鐢ㄦ埛淇℃伅**: 浠嶫WT payload瑙ｆ瀽骞剁紦瀛樺埌WorkspaceState
5. **澶村儚鍔犺浇**: 涓夌骇闄嶇骇绛栫暐(鍚庣URL 鈫?Gravatar 鈫?榛樿SVG)
6. **UI缁勪欢**: TreeView(鑰岄潪WebView)

**Dependencies**:
- jose ^5.0.0 (JWT瑙ｆ瀽)
- node-fetch ^3.0.0 (澶村儚涓嬭浇)

---

## Phase 1: Design & Contracts

**Status**: 鉁?Complete

**Outputs**:
- [data-model.md](./data-model.md) - 鏁版嵁妯″瀷瀹氫箟
- [contracts/api-spec.yaml](./contracts/api-spec.yaml) - OpenAPI 3.0瑙勮寖
- [contracts/README.md](./contracts/README.md) - API浣跨敤璇存槑
- [quickstart.md](./quickstart.md) - 蹇€熷紑濮嬫寚鍗?
**Key Entities**:
- UserProfile (鐢ㄦ埛璧勬枡,缂撳瓨鍒癢orkspaceState)
- JWTToken (瀛樺偍鍒癝ecretStorage)
- UploadFormData (琛ㄥ崟鏁版嵁,閭鍜岄」鐩悕鑷姩濉厖)
- AvatarCacheEntry (澶村儚缂撳瓨)

**API Contracts**:
- POST /api/auth/plugin (鎻掍欢鐧诲綍,鑾峰彇JWT)
- JWT Payload缁撴瀯: { email, role, exp, iat }

---

## Phase 2: Implementation Tasks

**Note**: Task breakdown is generated by /speckit.tasks command (not part of /speckit.plan).

See [tasks.md](./tasks.md) for the detailed task list (generated after running /cursor-helper/speckit.tasks).

---

## Appendix: Change Log

### 2026-01-15
- Initial plan created
- Corrected from OAuth 2.0 to simple JWT authentication
- Removed refresh token logic (backend doesn't support)
- Defined data model and API contracts
- Created quickstart guide for developers

---

**Plan Complete** 鉁? 
**Next Command**: /cursor-helper/speckit.tasks to generate implementation tasks
