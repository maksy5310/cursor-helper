# Feature Specification: Cursor工作空间会话支持

**Feature Branch**: `005-workspace-sessions`  
**Created**: 2026-01-15  
**Status**: Draft  
**Input**: User description: "增加对Cursor工作空间的支持。能够自动识别当前是打开的单个工程目录，还是工作空间。如何是工作空间，应该保持与CursorAI面板中的会话历史一致。好像是整合了工作空间中所有的子项目会话列表。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 自动识别工作空间类型并显示会话列表 (Priority: P1)

用户在Cursor中打开一个工作空间（单个工程目录或多根工作空间），插件能够自动识别当前工作空间类型，并在会话列表面板中显示相应的会话历史。对于多根工作空间，会话列表应该整合所有子项目的会话，与Cursor AI面板中的显示保持一致。

**Why this priority**: 这是核心功能，用户需要看到正确的会话历史，无论是单项目还是多项目工作空间。这是所有后续功能的基础。

**Independent Test**: 打开一个多根工作空间，验证会话列表面板显示所有子项目的会话，且与Cursor AI面板中的会话列表一致。可以独立验证工作空间类型识别和会话聚合功能。

**Acceptance Scenarios**:

1. **Given** 用户打开一个包含多个子项目的多根工作空间, **When** 用户查看会话列表面板, **Then** 系统显示所有子项目的会话，按时间倒序排列
2. **Given** 用户打开一个单根工作空间（单个工程目录）, **When** 用户查看会话列表面板, **Then** 系统仅显示该项目的会话
3. **Given** 用户切换工作空间（从单根切换到多根或反之）, **When** 会话列表面板刷新, **Then** 系统自动更新显示的会话列表以匹配新的工作空间类型

---

### User Story 2 - 会话列表与Cursor AI面板保持一致 (Priority: P1)

在多根工作空间中，插件显示的会话列表必须与Cursor AI面板中显示的会话历史完全一致，包括会话数量、顺序和内容。

**Why this priority**: 一致性是用户体验的关键。如果插件显示的会话与Cursor原生面板不一致，会导致用户困惑和信任问题。

**Independent Test**: 在多根工作空间中，同时打开Cursor AI面板和插件会话列表，对比两者显示的会话，验证数量、顺序和基本信息的一致性。可以独立测试数据聚合逻辑。

**Acceptance Scenarios**:

1. **Given** 多根工作空间中有3个子项目，每个项目都有会话记录, **When** 用户查看插件会话列表和Cursor AI面板, **Then** 两者显示的会话总数相同，且包含相同的会话ID
2. **Given** 用户在Cursor AI面板中看到会话按最后更新时间倒序排列, **When** 用户查看插件会话列表, **Then** 会话也按相同顺序排列
3. **Given** 用户在某个子项目中创建了新会话, **When** 会话列表刷新, **Then** 新会话立即出现在列表中，且位置与Cursor AI面板一致

---

### User Story 3 - 工作空间类型自动检测 (Priority: P2)

系统能够自动检测当前打开的是单根工作空间还是多根工作空间，无需用户手动配置。

**Why this priority**: 自动检测减少了用户配置负担，确保功能始终正确工作。虽然优先级略低于核心功能，但对用户体验很重要。

**Independent Test**: 在不同类型的工作空间之间切换，验证系统能够正确识别工作空间类型。可以独立测试工作空间检测逻辑。

**Acceptance Scenarios**:

1. **Given** 用户打开一个包含多个文件夹的工作空间文件（.code-workspace）, **When** 系统初始化, **Then** 系统识别为多根工作空间
2. **Given** 用户直接打开一个文件夹（单根工作空间）, **When** 系统初始化, **Then** 系统识别为单根工作空间
3. **Given** 用户从单根工作空间切换到多根工作空间, **When** 工作空间切换完成, **Then** 系统自动更新工作空间类型识别结果

---

### Edge Cases

- 当工作空间中的某个子项目没有会话记录时，系统如何处理？
- 当工作空间数据库文件不存在或无法访问时，系统如何降级处理？
- 当工作空间中的子项目路径发生变化时，系统如何匹配会话数据？
- 当用户同时打开多个Cursor窗口，每个窗口使用不同的工作空间时，系统如何区分？
- 当工作空间中的某个子项目被删除或移动时，系统如何处理该项目的会话记录？
- 当会话数据量非常大（数千个会话）时，系统如何保证性能？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能够自动检测当前工作空间是单根工作空间还是多根工作空间
- **FR-002**: 系统必须能够识别多根工作空间中的所有子项目
- **FR-003**: 系统必须能够从每个子项目的工作空间数据库中读取会话记录
- **FR-004**: 系统必须能够将多个子项目的会话记录合并为统一的会话列表
- **FR-005**: 系统必须按照会话的最后更新时间对合并后的会话列表进行排序（倒序）
- **FR-006**: 系统必须确保显示的会话列表与Cursor AI面板中的会话列表保持一致
- **FR-007**: 系统必须在工作空间切换时自动更新会话列表
- **FR-008**: 系统必须能够处理工作空间数据库不存在或无法访问的情况
- **FR-009**: 系统必须能够处理子项目路径变化的情况，通过路径匹配找到正确的数据库
- **FR-010**: 系统必须在会话列表刷新时重新检测工作空间类型和子项目

### Key Entities

- **工作空间类型**: 表示当前工作空间是单根还是多根，包含检测结果和子项目列表
- **子项目**: 多根工作空间中的单个项目文件夹，包含路径、名称和对应的数据库路径
- **会话记录**: 从Cursor数据库中读取的会话信息，包含会话ID、名称、最后更新时间等
- **合并会话列表**: 将多个子项目的会话记录合并后的统一列表，按时间排序

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系统能够在1秒内完成工作空间类型检测和子项目识别
- **SC-002**: 在多根工作空间中，插件显示的会话列表与Cursor AI面板的会话列表匹配率达到100%（会话数量、ID和顺序一致）
- **SC-003**: 工作空间切换后，会话列表能够在2秒内完成更新并显示正确的内容
- **SC-004**: 系统能够正确处理包含最多10个子项目的多根工作空间，会话列表加载时间不超过3秒
- **SC-005**: 用户无需任何手动配置即可使用工作空间会话功能，自动检测成功率100%
- **SC-006**: 当工作空间数据库不可访问时，系统能够优雅降级，显示空列表或错误提示，不会导致插件崩溃

## Assumptions

- Cursor使用工作空间数据库（state.vscdb）存储每个工作空间的会话数据
- 多根工作空间中，每个子项目可能有独立的工作空间数据库，或者共享一个工作空间数据库
- Cursor AI面板显示的会话列表是从所有相关的工作空间数据库中聚合得到的
- 工作空间数据库的路径可以通过工作空间路径和workspace.json文件匹配确定
- 会话记录包含足够的信息（如最后更新时间）用于排序和去重
