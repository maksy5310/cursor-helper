# Feature Specification: 记录上传到分享平台

**Feature Branch**: `003-upload-records`  
**Created**: 2025-12-15  
**Status**: Draft  
**Input**: User description: "我需要能够将产生的agent使用记录，上传到分享平台器上。这样可以在服务平台上查看自己的历史记录、分享或是评价他人。服务平台的接口定义@spec-share-server/specs/001-agent-records-share/contracts/api-contracts.md ，我希望在cursor-helper的插件面板上，提供使用记录上传功能，通过选择指定的记录，补充必要信息（项目/邮箱/时间/格式/内容）后上传到分享平台。"

## Clarifications

### Session 2025-12-16

- Q: 如何触发上传功能？是通过命令还是通过UI交互？ → A: 通过在侧边面板会话列表中点击会话项触发，不是通过执行命令
- Q: 用户如何选择要上传的会话？是否需要从本地文件选择？ → A: 用户在侧边面板会话列表中点击会话项，会话已通过点击选择，表单中无需再选择会话。不使用本地存储文件选择（本地存储文件已弃用）
- Q: 表单中是否需要提供内容编辑器？ → A: 表单内附加一个编辑器，用于会话内容的修改和预览。如果无法在表单内实现，也可以通过点击弹出编辑器实现

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 选择并上传记录 (Priority: P1)

用户在侧边面板会话列表中点击一个会话项，插件显示上传表单，用户填写必要信息（项目名称、邮箱、时间、格式等），可以在表单内编辑和预览会话内容，然后上传到分享平台，以便在服务平台上查看、分享或评价。

**Why this priority**: 这是核心功能，实现用户将本地记录上传到分享平台的主要目标。这是用户使用分享平台功能的基础。

**Independent Test**: 可以通过在侧边面板会话列表中点击一条会话，填写表单信息，然后验证记录是否成功上传到分享平台来测试。即使没有其他功能（如查看历史记录），上传功能本身也能提供价值。

**Acceptance Scenarios**:

1. **Given** 插件已安装并运行, **When** 用户在侧边面板会话列表中点击一条会话项, **Then** 插件显示上传表单，包含项目名称、邮箱、时间、格式、内容等字段，内容字段自动填充该会话的内容
2. **Given** 用户已点击会话项并显示表单, **When** 用户在表单内编辑会话内容（通过内嵌编辑器或弹出编辑器）, **Then** 用户可以修改和预览会话内容
3. **Given** 用户已填写表单并编辑内容, **When** 用户点击上传按钮, **Then** 插件将记录上传到分享平台，并显示上传成功或失败的反馈
4. **Given** 用户已填写表单但缺少必填字段, **When** 用户尝试上传, **Then** 插件显示验证错误提示，阻止上传
5. **Given** 用户已点击会话项, **When** 插件加载会话内容, **Then** 插件自动填充内容字段，用户可以选择内容格式（markdown/text/json/html）

---

### User Story 2 - 配置上传凭证 (Priority: P2)

用户在插件中配置 JWT Token，用于认证上传请求，确保只有授权用户才能上传记录。

**Why this priority**: 上传功能需要认证，配置凭证是使用上传功能的前提条件。虽然可以推迟到首次上传时配置，但提前配置能提供更好的用户体验。

**Independent Test**: 可以通过在插件设置中配置 JWT Token，然后验证上传请求是否包含正确的认证头来测试。

**Acceptance Scenarios**:

1. **Given** 插件已安装, **When** 用户打开插件设置, **Then** 用户可以看到 JWT Token 配置选项
2. **Given** 用户已配置 JWT Token, **When** 用户尝试上传记录, **Then** 插件使用配置的 Token 进行认证
3. **Given** 用户未配置 JWT Token 或 Token 已过期, **When** 用户尝试上传记录, **Then** 插件提示用户配置或更新 Token，并阻止上传

---

### User Story 3 - 查看上传状态和历史 (Priority: P3)

用户可以在插件中查看已上传记录的状态，了解哪些记录已成功上传，哪些上传失败，以便进行后续操作（如重试上传）。

**Why this priority**: 提供上传状态反馈能帮助用户了解上传结果，但这不是核心功能，可以后续实现。用户也可以直接在服务平台上查看上传的记录。

**Independent Test**: 可以通过上传记录后，在插件中查看上传状态列表来测试。即使没有此功能，用户仍可以通过服务平台查看上传的记录。

**Acceptance Scenarios**:

1. **Given** 用户已上传记录, **When** 用户在插件中查看上传历史, **Then** 插件显示已上传记录的列表，包含上传时间、状态等信息
2. **Given** 记录上传失败, **When** 用户查看上传状态, **Then** 插件显示失败原因，并提供重试选项

---

### Edge Cases

- 当网络连接不可用时，如何处理上传请求？ → 显示网络错误提示，允许用户稍后重试
- 当 JWT Token 过期时，如何处理？ → 提示用户更新 Token，阻止上传
- 当上传的内容超过 10MB 限制时，如何处理？ → 在上传前验证内容大小，如果超过限制则提示用户并阻止上传
- 当用户填写的时间是未来时间时，如何处理？ → 验证时间不能是未来时间，显示错误提示
- 当分享平台服务不可用时，如何处理？ → 显示服务不可用错误，允许用户稍后重试
- 当用户同时上传多条记录时，如何处理并发请求？ → 支持队列或并发上传，但需要限制并发数量以避免过载
- 当上传过程中用户关闭插件或 Cursor 时，如何处理？ → 记录上传状态，下次打开时显示未完成的上传
- 当用户点击的会话不存在或无法加载时，如何处理？ → 显示会话不存在或加载失败错误，允许用户重新选择
- 当表单内编辑器无法实现时，如何处理？ → 提供点击按钮弹出独立编辑器窗口
- 当上传请求超时时，如何处理？ → 显示超时错误，允许用户重试
- 当用户填写的邮箱格式无效时，如何处理？ → 验证邮箱格式，显示格式错误提示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 插件 MUST 在侧边面板会话列表中提供上传功能入口，用户点击会话项时触发上传表单显示
- **FR-002**: 插件 MUST 显示上传表单，包含以下字段：
  - 项目名称（必填，1-255字符）
  - 上传人邮箱（必填，有效邮箱格式）
  - 上传时间（必填，ISO 8601格式，不能是未来时间）
  - 内容格式（可选，默认'markdown'，枚举值：'markdown', 'text', 'json', 'html'）
  - 内容（必填，自动填充，最大10MB）
- **FR-003**: 插件 MUST 在用户点击会话项后自动从数据库加载该会话的内容并填充到内容字段
- **FR-004**: 插件 MUST 在表单内提供内容编辑器，允许用户编辑和预览会话内容（如果无法在表单内实现，可通过点击弹出编辑器实现）
- **FR-005**: 插件 MUST 验证表单字段，确保必填字段已填写且格式正确
- **FR-006**: 插件 MUST 在上传前验证内容大小不超过 10MB
- **FR-007**: 插件 MUST 支持配置 JWT Token 用于认证上传请求
- **FR-008**: 插件 MUST 在上传请求中包含 JWT Token 认证头（`Authorization: Bearer <token>`）
- **FR-009**: 插件 MUST 调用分享平台的 `POST /api/v1/records` 接口上传记录
- **FR-010**: 插件 MUST 处理上传响应，显示成功或失败消息
- **FR-011**: 插件 MUST 处理以下错误情况：
  - 400 Bad Request（字段验证失败）：显示具体验证错误信息
  - 401 Unauthorized（未提供或无效的token）：提示用户配置或更新 Token
  - 413 Payload Too Large（内容超过10MB）：提示用户内容过大
  - 500 Internal Server Error（服务器错误）：显示服务器错误，允许重试
- **FR-012**: 插件 MUST 支持配置分享平台的基础 URL（默认从 API 文档获取）
- **FR-013**: 插件 MUST 在上传过程中显示加载状态，防止重复提交
- **FR-014**: 插件 MUST 在网络错误或超时时允许用户重试上传

### Key Entities *(include if feature involves data)*

- **上传记录**: 包含项目名称、上传人邮箱、上传时间、内容格式、内容等字段的记录，用于上传到分享平台，具有验证规则和大小限制（最大10MB）
- **JWT Token**: 用于认证上传请求的凭证，包含用户邮箱、角色、过期时间等信息，需要配置在插件设置中
- **上传表单**: 包含项目名称、邮箱、时间、格式、内容等字段的表单，用于用户填写上传信息，具有必填字段验证和格式验证
- **上传状态**: 记录上传操作的结果（成功、失败、进行中），包含错误信息（如有），用于向用户提供反馈

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够成功上传至少 95% 的尝试上传记录（排除网络错误、Token 过期等外部因素）
- **SC-002**: 上传操作从用户点击上传按钮到收到响应反馈的时间不超过 5 秒（正常网络条件下）
- **SC-003**: 表单验证错误提示在用户提交后 1 秒内显示
- **SC-004**: 上传功能对插件性能的影响小于 3%（通过响应时间测量）
- **SC-005**: 用户能够在上传失败后成功重试上传（重试成功率达到 90% 以上）
- **SC-006**: 插件能够正确处理至少 99% 的 API 响应情况（成功、各种错误状态码）
- **SC-007**: 用户能够在 2 分钟内完成一次完整的上传流程（从选择记录到上传成功）

## Assumptions

- 分享平台服务可用且可访问
- 用户已获得有效的 JWT Token 用于认证
- Cursor 数据库访问层可用，能够读取会话数据
- 侧边面板会话列表已实现并可用
- 网络连接稳定，能够访问分享平台 API
- 用户了解如何获取和配置 JWT Token
- 分享平台 API 接口定义稳定，不会频繁变更

## Dependencies

- 分享平台 API 服务（`POST /api/v1/records` 接口）
- Cursor 数据库访问层（DatabaseAccess，由 001-cursor-assistant 功能提供，用于从数据库读取会话数据）
- 侧边面板会话列表（SessionListPanel，由 001-cursor-assistant 功能提供）
- JWT Token 认证机制
- 网络连接（用于与分享平台通信）

## Out of Scope

- 在插件中查看分享平台上的历史记录（用户应在服务平台上查看）
- 在插件中管理分享状态（分享/取消分享应在服务平台上操作）
- 在插件中搜索或筛选分享平台上的记录
- 批量上传多条记录（本规范仅支持单条记录上传）
- 自动上传功能（需要用户手动触发上传）
- 数据脱敏处理（应在选择记录时由用户决定是否脱敏）
- 上传进度显示（仅显示加载状态，不显示详细进度）
- 上传队列管理（支持并发但不在范围内）
- 从本地存储文件选择记录（本地存储文件已弃用，改为从数据库读取会话数据）

