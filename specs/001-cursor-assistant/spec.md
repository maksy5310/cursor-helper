# Feature Specification: Cursor助手插件

**Feature Branch**: `001-cursor-assistant`  
**Created**: 2025-12-10  
**Status**: Draft  
**Input**: User description: "编写一个cursor插件名称暂定'Cursor助手'。1、通过分析Cursor自带的数据库或是cursor底层visual studio code的数据库或调用内部API、数据文件，实现Cursor使用数据采集（包含不限于Tab键自动补全\cmd+K行内自动补全\Agent对话模式的建议次数、采纳次数、建议代码行数、采纳代码行数、提交代码行数等等）2、能够自动上传使用CursorAI的聊天会话记录，上传前需要用户确认，并进行脱敏处理。"

## Clarifications

### Session 2025-12-10

- Q: Cursor 代码辅助模式的术语澄清 → A: Cursor 有三种代码辅助模式：1) Tab键自动补全 2) cmd+K 行内自动补全 3) Agent 对话模式。规范中的"tab"指 Tab键自动补全模式，"行内编辑"指 cmd+K 行内自动补全模式。
- Q: 插件应如何访问 Cursor 的使用数据？ → A: 支持多种方式，按可用性自动选择（数据库优先，API 次之，文件最后）
- Q: 数据访问方式的实现范围 → A: 仅实现数据库访问方式，移除 API 和文件访问方式（目前不具备实现条件）
- Q: 上传功能的实现时机 → A: 先实现本地文件存储，上传功能推迟到后续版本设计
- Q: 本地存储的文件格式和组织方式 → A: 在当前工作空间目录下创建 "./cursor-helper" 目录，按日期 "yyyy-mm-dd" 创建子目录，所有文件存储在当日的子目录中，使用 JSON 格式
- Q: 数据文件的命名规则 → A: 按数据类型和时间戳命名（如 "stats-2025-12-10-143022.json" 和 "chat-2025-12-10-143022.json"）
- Q: 插件应何时采集和保存数据？ → A: 实时采集每个事件，但批量写入文件（如每 10 秒或累积 100 条记录后写入）
- Q: Agent 模式的数据采集范围 → A: 需要记录 Agent 的完整对话记录，包括所有消息、上下文和代码片段，同时记录建议次数和采纳次数
- Q: Agent 对话记录应如何存储？ → A: 单独存储为独立的文件（如 "agent-yyyy-mm-dd-HHMMSS.json"）
- Q: Agent 对话记录应包含哪些具体内容？ → A: 包含所有对话内容：文本消息、代码片段、文件路径、时间戳、上下文信息等
- Q: 聊天记录和 Agent 使用记录的关系 → A: 聊天记录和 Agent 使用记录合并，统一使用 Agent 对话记录存储所有对话内容（包括普通聊天和 Agent 模式）
- Q: Cursor 数据存储的具体位置和格式 → A: Cursor 将数据存储在 SQLite 数据库中，位置为 `%APPDATA%/Cursor/User/globalStorage/state.vscdb`（Windows），数据库包含两张表，存储 AI 使用统计数据和聊天记录
- Q: 如何访问 Cursor 的 composer 和 bubble 数据？ → A: 通过访问两个数据库文件实现：1) 工作空间数据库（`workspaceStorage/<workspace-id>/state.vscdb`）的 `ItemTable` 表，key 为 `composer.composerData`，获取 composer 列表；2) 全局数据库（`globalStorage/state.vscdb`）的 `CursorDiskKV` 表，key 格式为 `composerData:<composerId>` 和 `bubbleId:<composerId>:<bubbleId>`，获取详细数据
- Q: Panel 的位置和类型 → A: 侧边栏 TreeView（类似资源管理器，在活动栏显示图标）
- Q: 会话列表的显示内容和交互功能 → A: 仅显示会话名称列表，无交互
- Q: 会话列表的更新机制 → A: 通过检测数据库变化，使用 Node.js 的 fs.watch 监听数据库日志文件 state.vscdb-wal 的变化，增加定时检查和防抖设计（已更新：关闭监视与轮询检查机制，改为用户主动刷新）
- Q: 会话列表的显示范围 → A: 显示当前工作空间的所有会话
- Q: 会话列表的排序方式 → A: 按最后更新时间降序（最新的在前）
- Q: 如何确定当前工作空间的数据库路径？ → A: 遍历 `workspaceStorage` 目录下的每个文件夹，读取其中的 `workspace.json` 文件（格式为 `{"folder": "file:///..."}`），如果 `folder` 的值（URL 解码后）等于当前工作空间的路径，则该文件夹对应的数据库即为当前工作空间的数据库
- Q: 批量写入策略的触发条件 → A: 任一条件满足即触发（10 秒到期或累积 100 条记录），即如果累积达到 100 条记录则立即写入，或者如果距离上次写入已超过 10 秒则写入，两者满足其一即触发写入
- Q: 会话列表更新的防抖延迟时间 → A: 500 毫秒（平衡响应性和性能，避免过于频繁的刷新）
- Q: 工作空间数据库匹配失败时的处理策略 → A: 显示错误信息（如 "无法找到工作空间数据库"），让用户知道问题所在
- Q: 数据采集失败时的重试策略 → A: 记录错误但不重试（避免影响 Cursor 性能，符合 FR-009 要求）
- Q: 数据库监听器的定时检查间隔 → A: 30 秒（平衡及时性和性能，作为 fs.watch 的补充或回退机制）
- Q: 是否需要实时监视和轮询检查机制？ → A: 不需要，关闭监视与轮询检查机制，避免额外的性能影响，用户不需要实时扫描变化

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 使用数据自动采集 (Priority: P1)

用户安装并启用 Cursor助手插件后，插件自动在后台收集 Cursor 的使用数据，包括代码建议、采纳情况、编辑行为等统计信息，无需用户手动操作即可持续记录使用情况。

**Why this priority**: 这是插件的核心功能，为用户提供使用数据分析的基础。数据采集是后续分析和上传功能的前提。

**Independent Test**: 可以通过安装插件、使用 Cursor 进行正常开发工作，然后查看插件收集的数据来验证。即使没有上传功能，数据采集本身也能提供价值（本地查看）。

**Acceptance Scenarios**:

1. **Given** 插件正在运行, **When** 用户提交代码到版本控制系统, **Then** 插件记录提交的代码行数
2. **Given** 插件正在运行, **When** 用户使用 Tab键自动补全功能, **Then** 插件记录 Tab键自动补全的建议次数、采纳次数和建议代码行数
3. **Given** 插件正在运行, **When** 用户使用 cmd+K 行内自动补全功能, **Then** 插件记录 cmd+K 行内自动补全的建议次数、采纳次数和建议代码行数
4. **Given** 插件正在运行, **When** 用户使用 Agent 对话模式, **Then** 插件记录 Agent的完整对话记录、Agent 对话模式的建议次数和采纳次数

---

### User Story 2 - 数据本地存储 (Priority: P2)

插件将采集的使用数据和对话记录（包括普通聊天和 Agent 模式）保存到本地文件系统，供用户后续查看或导出。

**Why this priority**: 数据采集后需要持久化存储，本地存储是基础功能，为后续的上传功能提供数据源。

**Independent Test**: 可以通过使用 Cursor 进行开发工作，然后检查本地存储文件是否存在且包含正确的数据来验证。

**Acceptance Scenarios**:

1. **Given** 插件正在采集数据, **When** 数据采集事件发生, **Then** 插件将数据保存到本地文件
2. **Given** 插件正在运行, **When** 用户使用 Cursor AI 进行聊天会话（包括普通聊天和 Agent 模式）, **Then** 插件将对话记录保存到 Agent 记录文件中
3. **Given** 插件已保存数据到本地, **When** 用户查看本地存储目录, **Then** 可以看到结构化的数据文件
4. **Given** 插件正在保存数据, **When** 磁盘空间不足, **Then** 插件记录错误但不影响 Cursor 的正常使用

---

### User Story 3 - 会话列表显示 (Priority: P2)

用户在 Cursor 侧边栏可以查看当前工作空间的所有会话列表，帮助了解和管理 AI 对话会话。

**Why this priority**: 提供可视化的会话管理界面，增强用户体验，方便用户查看和管理会话。

**Independent Test**: 可以通过打开 Cursor 侧边栏，查看会话列表 panel 是否正确显示当前工作空间的所有会话，并验证列表是否按最后更新时间排序。

**Acceptance Scenarios**:

1. **Given** 插件已安装并启用, **When** 用户打开 Cursor 侧边栏, **Then** 可以看到会话列表 panel 显示当前工作空间的所有会话名称
2. **Given** 会话列表 panel 正在显示, **When** 用户主动刷新会话列表（如点击刷新按钮或重新打开 panel）, **Then** 会话列表更新为最新的会话数据
3. **Given** 会话列表 panel 正在显示, **When** 用户查看会话列表, **Then** 会话按最后更新时间降序排列（最新的会话显示在最前面）

---

### Edge Cases

- 当 Cursor 数据库不可访问时，插件如何处理数据采集失败？ → 已澄清：记录错误但不重试（FR-009.1）
- 当用户同时使用多个 Cursor 实例时，如何避免重复采集数据？
- 当本地存储文件过大时，如何处理（文件大小限制、文件轮转等）？
- 当本地磁盘空间不足时，如何处理数据存储？
- 当工作空间目录不存在或无法创建 "./cursor-helper" 目录时，如何处理？
- 当同一天的数据文件需要追加写入时，如何处理文件冲突？
- 当数据采集频率过高导致性能影响时，如何优化？
- 当用户拒绝授予插件访问 Cursor 数据的权限时，如何提示用户？
- 当本地存储文件损坏或格式错误时，如何处理？
- 当工作空间数据库无法访问时，会话列表 panel 如何显示（显示错误信息还是空列表）？ → 已澄清：显示错误信息（FR-012.3.1）
- 当会话数量过多（如超过 100 个）时，会话列表 panel 的性能如何保证？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 插件 MUST 通过数据库访问方式获取 Cursor 的使用数据（仅使用数据库访问，不实现 API 和文件访问方式）
- **FR-001.1**: 插件 MUST 能够访问工作空间数据库（`workspaceStorage/<workspace-id>/state.vscdb`）的 `ItemTable` 表，读取 key 为 `composer.composerData` 的记录以获取所有 composer 列表
- **FR-001.1.1**: 插件 MUST 通过遍历 `workspaceStorage` 目录下的每个文件夹，读取其中的 `workspace.json` 文件来匹配当前工作空间，`workspace.json` 文件格式为 `{"folder": "file:///..."}`，需要将 `folder` 值进行 URL 解码后与当前工作空间路径进行比较
- **FR-001.2**: 插件 MUST 能够访问全局数据库（`globalStorage/state.vscdb`）的 `CursorDiskKV` 表，通过 key 格式 `composerData:<composerId>` 获取 composer 详细信息，通过 key 格式 `bubbleId:<composerId>:<bubbleId>` 获取气泡（消息）详细信息
- **FR-002**: 插件 MUST 自动采集以下数据指标：
  - Tab键自动补全模式的建议次数、采纳次数和建议代码行数
  - cmd+K 行内自动补全模式的建议次数、采纳次数和建议代码行数
  - Agent 对话模式的建议次数和采纳次数
  - Agent 对话模式的完整对话记录（包括所有消息、上下文和代码片段）
  - 提交到版本控制系统的代码行数
- **FR-003**: 插件 MUST 在后台持续运行，无需用户手动触发数据采集
- **FR-003.1**: 插件 MUST 实时采集每个数据事件（建议、采纳、提交等），但采用批量写入策略以优化性能：任一条件满足即触发写入（累积达到 100 条记录或距离上次写入超过 10 秒）
- **FR-004**: 插件 MUST 能够识别和访问 Cursor AI 的所有对话记录（包括普通聊天和 Agent 模式）
- **FR-005**: 插件 MUST 在当前工作空间目录下创建 "./cursor-helper" 目录用于数据存储
- **FR-006**: 插件 MUST 按日期格式 "yyyy-mm-dd" 在 "./cursor-helper" 目录下创建子目录
- **FR-007**: 插件 MUST 将采集的使用统计数据以 JSON 格式保存到当日的子目录中，文件名格式为 "stats-yyyy-mm-dd-HHMMSS.json"（包含时间戳）
- **FR-008**: 插件 MUST 将所有对话记录（包括普通聊天和 Agent 模式）统一以 Agent 对话记录格式保存到当日的子目录中，文件名格式为 "agent-yyyy-mm-dd-HHMMSS.json"（包含时间戳），记录内容包括：文本消息、代码片段、文件路径、时间戳、上下文信息等所有对话相关内容
- **FR-009**: 插件 MUST 在数据采集失败时记录错误但不影响 Cursor 的正常使用
- **FR-009.1**: 当数据库访问失败或数据采集失败时，插件 MUST 记录错误日志但不进行重试（避免影响 Cursor 性能和用户体验）
- **FR-010**: 插件 MUST 提供数据采集的开关配置，允许用户启用或禁用数据采集功能
- **FR-011**: 插件 MUST 在本地存储空间不足时记录错误但不影响 Cursor 的正常使用
- **FR-012**: 插件 MUST 在 Cursor 侧边栏提供一个 TreeView panel，用于显示当前的会话列表
- **FR-012.1**: 会话列表 panel MUST 显示会话名称列表，无需交互功能（仅用于查看）
- **FR-012.2**: 会话列表 panel MUST 在用户主动刷新时更新会话列表（不实现自动监视和轮询检查机制，避免性能影响）
- **FR-012.3**: 会话列表 panel MUST 仅显示当前工作空间的所有会话，不显示其他工作空间的会话
- **FR-012.3.1**: 当无法匹配到当前工作空间的数据库时，会话列表 panel MUST 显示错误信息（如 "无法找到工作空间数据库"）而不是空列表或错误数据
- **FR-012.4**: 会话列表 panel MUST 按会话的最后更新时间降序排列（最新的会话显示在最前面）

### Key Entities *(include if feature involves data)*

- **使用统计数据**: 包含代码建议、采纳、提交等各类使用指标的聚合数据，具有时间戳、指标类型、数值等属性，以 JSON 格式存储在本地文件中（文件名格式：stats-yyyy-mm-dd-HHMMSS.json）
- **Agent 对话记录**: 所有 Cursor AI 对话的完整记录（包括普通聊天和 Agent 模式），包含文本消息、代码片段、文件路径、时间戳、上下文信息等所有对话相关内容，以 JSON 格式存储在本地文件中（文件名格式：agent-yyyy-mm-dd-HHMMSS.json）
- **本地存储目录结构**: 在当前工作空间目录下的 "./cursor-helper" 目录，按日期 "yyyy-mm-dd" 组织子目录，每日的数据文件存储在对应的日期子目录中

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 插件能够成功采集至少 95% 的 Cursor 使用数据事件（建议、采纳、提交等）
- **SC-002**: 数据采集功能对 Cursor 性能的影响小于 5%（通过响应时间测量）
- **SC-003**: 插件在 Cursor 启动后 10 秒内完成初始化并开始数据采集
- **SC-004**: 本地文件存储操作的成功率达到 99% 以上（排除磁盘空间不足等系统级错误）
- **SC-005**: 数据从采集到写入文件的延迟不超过批量写入间隔（如 10 秒）或累积阈值（如 100 条记录）
- **SC-006**: 本地存储文件采用结构化格式，便于后续读取和解析
- **SC-007**: 会话列表 panel 能够在 Cursor 启动后 5 秒内完成初始化并显示会话列表
- **SC-008**: 会话列表 panel 在用户主动刷新时，更新延迟不超过 2 秒（从刷新操作到列表更新完成）
- **SC-009**: 会话列表 panel 对 Cursor 性能的影响小于 2%（通过响应时间测量，不包含后台监视和轮询的开销）

## Assumptions

- Cursor 提供了可访问的数据库接口，插件可以通过数据库访问获取使用数据
- 用户同意插件访问 Cursor 的使用数据和聊天会话记录
- 插件需要兼容 Cursor 的当前版本，未来版本兼容性可能需要额外开发
- 数据采集采用本地文件存储，所有数据保存在用户本地
- 用户有足够的本地磁盘空间用于存储数据文件
- 上传功能将在后续版本中设计和实现

## Dependencies

- Cursor 编辑器环境（作为插件运行平台）
- Cursor 内部数据库访问接口（SQLite 数据库文件）
- 本地文件系统（用于数据存储）

## Out of Scope

- 数据上传到服务器功能（将在后续版本中实现）
- 数据分析和可视化功能（本规范仅关注数据采集和本地存储，会话列表 panel 仅用于显示，不包含数据分析功能）
- 多用户数据聚合和分析
- 实时数据同步
- 数据导出功能（除本地存储外的其他导出方式）
- 脱敏处理功能（将在上传功能实现时一并设计）
