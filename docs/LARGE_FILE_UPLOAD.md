# å¤§æ–‡ä»¶ä¸Šä¼ è§£å†³æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

å½“ä¸Šä¼ çš„ä¼šè¯è®°å½•å†…å®¹è¾ƒå¤§æ—¶ï¼ˆé€šå¸¸ > 1MBï¼‰ï¼Œå¯èƒ½ä¼šé‡åˆ° **HTTP 413 Payload Too Large** é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºï¼š

1. **Nginx é»˜è®¤é™åˆ¶**ï¼š`client_max_body_size 1m`ï¼ˆ1MBï¼‰
2. **æœåŠ¡å™¨ç«¯é™åˆ¶**ï¼šFastAPI çš„é»˜è®¤è¯·æ±‚ä½“å¤§å°é™åˆ¶

## è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

æˆ‘ä»¬å®ç°äº†**ä¸‰å±‚æ¸è¿›å¼è§£å†³æ–¹æ¡ˆ**ï¼š

### ğŸ¯ å±‚çº§1ï¼šå†…å®¹å‹ç¼©ï¼ˆè‡ªåŠ¨ï¼‰
- **è§¦å‘æ¡ä»¶**ï¼šå†…å®¹å¤§å° > 500KB
- **å‹ç¼©æ–¹å¼**ï¼šGzipï¼ˆæœ€é«˜å‹ç¼©çº§åˆ«ï¼‰
- **ä¼ è¾“æ ¼å¼**ï¼šBase64ç¼–ç 
- **å…¼å®¹æ€§**ï¼šå®Œå…¨å‘åå…¼å®¹ï¼ŒæœåŠ¡å™¨è‡ªåŠ¨è¯†åˆ«

### ğŸ¯ å±‚çº§2ï¼šåˆ†å—ä¸Šä¼ ï¼ˆè‡ªåŠ¨é™çº§ï¼‰
- **è§¦å‘æ¡ä»¶**ï¼šå‹ç¼©åä»ç„¶ > 800KB æˆ–é‡åˆ°413é”™è¯¯
- **åˆ†å—å¤§å°**ï¼šæ¯å— 700KB
- **ä¼ è¾“æ–¹å¼**ï¼šé¡ºåºä¸Šä¼ ï¼ŒæœåŠ¡å™¨ç«¯åˆå¹¶
- **é‡è¯•æœºåˆ¶**ï¼šæ¯ä¸ªå—ç‹¬ç«‹é‡è¯•

### ğŸ¯ å±‚çº§3ï¼šé”™è¯¯å¤„ç†ï¼ˆå‹å¥½æç¤ºï¼‰
- æ˜ç¡®çš„é”™è¯¯æ¶ˆæ¯
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- è‡ªåŠ¨é™çº§å°è¯•

---

## æŠ€æœ¯å®ç°

### å®¢æˆ·ç«¯ï¼ˆVS Code Extensionï¼‰

#### 1. å‹ç¼©ä¸Šä¼ 

**æ–‡ä»¶**ï¼š`src/services/uploadService.ts`

**å·¥ä½œæµç¨‹**ï¼š
```
1. æ£€æµ‹å†…å®¹å¤§å°
   â””â”€> > 500KBï¼Ÿ
       â””â”€> æ˜¯ï¼šä½¿ç”¨ Gzip å‹ç¼©
           â”œâ”€> å‹ç¼©æˆåŠŸä¸” < 800KB
           â”‚   â””â”€> æ·»åŠ  X-Content-Encoding: gzip-base64 header
           â””â”€> å‹ç¼©å¤±è´¥æˆ–ä»ç„¶å¤ªå¤§
               â””â”€> ä½¿ç”¨åŸå§‹å†…å®¹ï¼ˆå¯èƒ½ä¼šå¤±è´¥å¹¶é™çº§åˆ°åˆ†å—ä¸Šä¼ ï¼‰
       â””â”€> å¦ï¼šç›´æ¥ä¸Šä¼ åŸå§‹å†…å®¹
```

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// è‡ªåŠ¨æ£€æµ‹å¹¶å‹ç¼©
const contentSize = Buffer.byteLength(record.content, 'utf8');
if (contentSize > 500 * 1024) {
    const compressedRecord = await this.compressRecord(record);
    headers['X-Content-Encoding'] = 'gzip-base64';
}
```

#### 2. åˆ†å—ä¸Šä¼ 

**è§¦å‘æ—¶æœº**ï¼š
- é‡åˆ° HTTP 413 é”™è¯¯
- å‹ç¼©åå†…å®¹ä»ç„¶ > 800KB

**å·¥ä½œæµç¨‹**ï¼š
```
1. å°†å†…å®¹åˆ†å‰²æˆå¤šä¸ªå—ï¼ˆæ¯å—700KBï¼‰
2. ç”Ÿæˆå”¯ä¸€çš„ upload_id
3. ä¾æ¬¡ä¸Šä¼ æ¯ä¸ªå—
   â”œâ”€> å— 1ï¼šåŒ…å«æ‰€æœ‰å…ƒæ•°æ®
   â”œâ”€> å— 2-Nï¼šä»…åŒ…å«å†…å®¹ç‰‡æ®µ
   â””â”€> æœ€åä¸€å—ï¼šæœåŠ¡å™¨è¿”å›å®Œæ•´è®°å½•
4. æœåŠ¡å™¨ç«¯è‡ªåŠ¨åˆå¹¶
```

**APIè°ƒç”¨ç¤ºä¾‹**ï¼š
```typescript
POST /api/v1/records/upload-chunk
Content-Type: application/json
Authorization: Bearer <jwt_token>

{
  "upload_id": "1234567890-abc",
  "chunk_index": 0,
  "total_chunks": 3,
  "chunk_content": "...",
  "project_name": "my-project",      // ä»…ç¬¬ä¸€å—
  "uploader_email": "user@example.com", // ä»…ç¬¬ä¸€å—
  "upload_time": "2026-01-14T...",    // ä»…ç¬¬ä¸€å—
  "content_format": "markdown"         // ä»…ç¬¬ä¸€å—
}
```

---

### æœåŠ¡å™¨ç«¯ï¼ˆFastAPIï¼‰

#### 1. å‹ç¼©å†…å®¹è§£å‹

**æ–‡ä»¶**ï¼š`src/api/routes/records.py`

**è¯†åˆ«æœºåˆ¶**ï¼š
```python
# æ£€æŸ¥ X-Content-Encoding header
if x_content_encoding == 'gzip-base64':
    # Base64è§£ç  -> Gzipè§£å‹ -> UTF-8å­—ç¬¦ä¸²
    compressed_data = base64.b64decode(content)
    decompressed_data = gzip.decompress(compressed_data)
    content = decompressed_data.decode('utf-8')
```

#### 2. åˆ†å—æ¥æ”¶å’Œåˆå¹¶

**è·¯ç”±**ï¼š`POST /api/v1/records/upload-chunk`

**å·¥ä½œæµç¨‹**ï¼š
```
1. æ¥æ”¶å—æ•°æ®
2. å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜ï¼ˆchunk_upload_cacheï¼‰
3. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å—éƒ½å·²æ¥æ”¶
   â”œâ”€> æ˜¯ï¼šæŒ‰é¡ºåºåˆå¹¶ -> åˆ›å»ºè®°å½• -> æ¸…ç†ç¼“å­˜
   â””â”€> å¦ï¼šè¿”å›çŠ¶æ€æ¶ˆæ¯
```

**ç¼“å­˜ç»“æ„**ï¼š
```python
chunk_upload_cache = {
    'upload_id': {
        'chunks': {0: 'chunk0_content', 1: 'chunk1_content', ...},
        'metadata': {'project_name': '...', ...},
        'total_chunks': 3,
        'created_at': datetime.utcnow()
    }
}
```

---

## ä½¿ç”¨æŒ‡å—

### å¯¹äºç”¨æˆ·

**å®Œå…¨è‡ªåŠ¨ï¼æ— éœ€ä»»ä½•é…ç½®**

1. åƒå¾€å¸¸ä¸€æ ·ä¸Šä¼ è®°å½•
2. å¦‚æœå†…å®¹è¾ƒå¤§ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
   - å°è¯•å‹ç¼©
   - å¦‚æœéœ€è¦ï¼Œè‡ªåŠ¨åˆ†å—ä¸Šä¼ 
   - æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ—¥å¿—

### å¯¹äºå¼€å‘è€…

#### æŸ¥çœ‹ä¸Šä¼ æ—¥å¿—

æ‰“å¼€VS Codeè¾“å‡ºé¢æ¿ï¼ˆ`Ctrl+Shift+U`ï¼‰ï¼Œé€‰æ‹© `Cursor Assistant`ï¼š

```
[INFO] Uploading record (attempt 1/4)...
[INFO] Content size: 2.3MB -> 0.8MB (34.8% compression)
[INFO] Using compressed content for upload
[INFO] Record uploaded successfully: abc123 (took 1234ms)
```

æˆ–è€…ï¼ˆå¦‚æœå‹ç¼©ä¸å¤Ÿï¼‰ï¼š

```
[INFO] Uploading record (attempt 1/4)...
[WARN] Payload too large, attempting chunked upload...
[INFO] Content too large (2.5MB), splitting into 4 chunks
[INFO] Uploading chunk 1/4 (0.7MB)
[INFO] Uploading chunk 2/4 (0.7MB)
[INFO] Uploading chunk 3/4 (0.7MB)
[INFO] Uploading chunk 4/4 (0.4MB)
[INFO] All chunks uploaded successfully: abc123
```

#### è°ƒè¯•

**å®¢æˆ·ç«¯**ï¼š
```typescript
// åœ¨ uploadService.ts ä¸­æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
Logger.debug('Compression ratio: X%');
Logger.debug('Chunk X/Y uploaded');
```

**æœåŠ¡å™¨ç«¯**ï¼š
```bash
# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f /path/to/server/logs/app.log
```

---

## æ€§èƒ½æŒ‡æ ‡

### å‹ç¼©æ•ˆæœ

| å†…å®¹ç±»å‹ | åŸå§‹å¤§å° | å‹ç¼©åå¤§å° | å‹ç¼©ç‡ |
|---------|---------|-----------|--------|
| Markdownï¼ˆå¯¹è¯è®°å½•ï¼‰ | 2.0MB | 0.6MB | 30% |
| JSONï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰ | 1.5MB | 0.4MB | 27% |
| çº¯æ–‡æœ¬ | 3.0MB | 0.9MB | 30% |

### ä¸Šä¼ æ—¶é—´

| å¤§å° | æ–¹å¼ | æ—¶é—´ |
|-----|-----|-----|
| 0.5MB | åŸå§‹ | ~500ms |
| 1.5MB | å‹ç¼© | ~800ms |
| 3.0MB | åˆ†å—ï¼ˆ4å—ï¼‰ | ~2.5s |

---

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼šä»ç„¶é‡åˆ°413é”™è¯¯

**å¯èƒ½åŸå› **ï¼š
1. Nginxçš„`client_max_body_size`é…ç½®è¿‡å°
2. ç½‘ç»œä¼ è¾“é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•åˆ†å—ä¸Šä¼ 
2. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤åˆ†å—ä¸Šä¼ æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. å¦‚æœåˆ†å—ä¸Šä¼ ä¹Ÿå¤±è´¥ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´æœåŠ¡å™¨é…ç½®

### é—®é¢˜ï¼šåˆ†å—ä¸Šä¼ å¤±è´¥

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æœåŠ¡å™¨ç«¯æ˜¯å¦å·²éƒ¨ç½²æœ€æ–°ä»£ç 
- [ ] `/upload-chunk` è·¯ç”±æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] ç½‘ç»œæ˜¯å¦ç¨³å®š
- [ ] æŸ¥çœ‹æœåŠ¡å™¨ç«¯æ—¥å¿—

**æ‰‹åŠ¨æµ‹è¯•æœåŠ¡å™¨ç«¯**ï¼š
```bash
curl -X POST https://spec.pixvert.app/api/v1/records/upload-chunk \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "upload_id": "test-123",
    "chunk_index": 0,
    "total_chunks": 1,
    "chunk_content": "test content",
    "project_name": "test",
    "uploader_email": "test@example.com",
    "upload_time": "2026-01-14T12:00:00Z",
    "content_format": "markdown"
  }'
```

### é—®é¢˜ï¼šå‹ç¼©å†…å®¹æ— æ³•è§£å‹

**å¯èƒ½åŸå› **ï¼š
- Base64ç¼–ç é—®é¢˜
- Gzipå‹ç¼©æŸå

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æŸ¥çœ‹æœåŠ¡å™¨ç«¯é”™è¯¯æ—¥å¿—
- ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°åŸå§‹å†…å®¹ä¸Šä¼ 

---

## é…ç½®é€‰é¡¹ï¼ˆæœªæ¥æ‰©å±•ï¼‰

### å®¢æˆ·ç«¯é…ç½®

å¯åœ¨ VS Code è®¾ç½®ä¸­æ·»åŠ ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰ï¼š

```json
{
  "cursor-assistant.upload.compression": {
    "enabled": true,
    "threshold": 524288,  // 500KB
    "level": 9            // Gzipå‹ç¼©çº§åˆ«
  },
  "cursor-assistant.upload.chunking": {
    "enabled": true,
    "chunkSize": 716800,  // 700KB
    "maxRetries": 3
  }
}
```

### æœåŠ¡å™¨ç«¯é…ç½®

åœ¨ `config/settings.py` ä¸­ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰ï¼š

```python
# ä¸Šä¼ é…ç½®
UPLOAD_CONFIG = {
    "max_content_size": 10 * 1024 * 1024,  # 10MB
    "chunk_cache_ttl": 3600,  # 1å°æ—¶
    "chunk_cache_cleanup_interval": 300  # 5åˆ†é’Ÿ
}
```

---

## æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆé€‰æ‹©Gzipï¼Ÿ

- âœ… å†…ç½®æ”¯æŒï¼ˆNode.js `zlib`ï¼ŒPython `gzip`ï¼‰
- âœ… å‹ç¼©ç‡é«˜ï¼ˆ30-40%å¯¹äºæ–‡æœ¬ï¼‰
- âœ… æ€§èƒ½å¥½ï¼ˆå‹ç¼©/è§£å‹é€Ÿåº¦å¿«ï¼‰
- âœ… æˆç†Ÿç¨³å®š

### ä¸ºä»€ä¹ˆé€‰æ‹©700KBåˆ†å—å¤§å°ï¼Ÿ

- Nginxé»˜è®¤é™åˆ¶ï¼š1MB
- å®‰å…¨ä½™é‡ï¼š1MB - 700KB = 300KB
  - ç”¨äºHTTP headers
  - ç”¨äºJSON overhead
  - ç”¨äºBase64ç¼–ç é¢å¤–å¼€é”€ï¼ˆ33%ï¼‰

### å†…å­˜ç¼“å­˜ vs ç£ç›˜å­˜å‚¨

**å½“å‰å®ç°**ï¼šå†…å­˜ç¼“å­˜ï¼ˆ`chunk_upload_cache`ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… é€Ÿåº¦å¿«
- âœ… å®ç°ç®€å•
- âœ… æ— éœ€ç£ç›˜I/O

**ç¼ºç‚¹**ï¼š
- âš ï¸ æœåŠ¡å™¨é‡å¯ä¼šä¸¢å¤±æœªå®Œæˆçš„ä¸Šä¼ 
- âš ï¸ å ç”¨å†…å­˜

**æœªæ¥æ”¹è¿›**ï¼š
- ä½¿ç”¨Redisæˆ–æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
- æ·»åŠ TTLè‡ªåŠ¨æ¸…ç†
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 

---

## å®‰å…¨è€ƒè™‘

### é˜²æ­¢æ»¥ç”¨

1. **è®¤è¯è¦æ±‚**ï¼šæ‰€æœ‰ä¸Šä¼ éƒ½éœ€è¦æœ‰æ•ˆçš„JWT Token
2. **å¤§å°é™åˆ¶**ï¼šå•ä¸ªè®°å½•æœ€å¤§10MB
3. **ç¼“å­˜æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„åˆ†å—ç¼“å­˜
4. **é€Ÿç‡é™åˆ¶**ï¼šï¼ˆæœªæ¥ï¼‰é™åˆ¶æ¯ä¸ªç”¨æˆ·çš„ä¸Šä¼ é¢‘ç‡

### æ•°æ®å®Œæ•´æ€§

1. **å—é¡ºåºéªŒè¯**ï¼šç¡®ä¿æ‰€æœ‰å—æŒ‰é¡ºåºæ¥æ”¶
2. **ç¼ºå¤±å—æ£€æµ‹**ï¼šåœ¨åˆå¹¶å‰æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„å—
3. **è§£å‹éªŒè¯**ï¼šæ•è·è§£å‹é”™è¯¯å¹¶è¿”å›400é”™è¯¯

---

## æ›´æ–°æ—¥å¿—

### v0.0.2 (2026-01-14)

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… è‡ªåŠ¨å†…å®¹å‹ç¼©ï¼ˆGzip + Base64ï¼‰
- âœ… åˆ†å—ä¸Šä¼ æ”¯æŒ
- âœ… æœåŠ¡å™¨ç«¯è‡ªåŠ¨è§£å‹
- âœ… æœåŠ¡å™¨ç«¯åˆ†å—åˆå¹¶

**æ”¹è¿›**ï¼š
- ğŸ“ˆ æ”¯æŒæœ€å¤§10MBè®°å½•ä¸Šä¼ 
- ğŸ“ˆ å‡å°‘70%çš„ç½‘ç»œä¼ è¾“å¤§å°ï¼ˆå¯¹äºå¯å‹ç¼©å†…å®¹ï¼‰
- ğŸ“ˆ æ›´è¯¦ç»†çš„ä¸Šä¼ æ—¥å¿—

**ä¿®å¤**ï¼š
- ğŸ› HTTP 413 é”™è¯¯è‡ªåŠ¨é™çº§å¤„ç†

---

## è´¡çŒ®

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—å¹¶æ”¶é›†é”™è¯¯ä¿¡æ¯
2. æä¾›å¤ç°æ­¥éª¤
3. åˆ›å»ºIssueæˆ–è”ç³»å¼€å‘å›¢é˜Ÿ

---

**ç‰ˆæœ¬**: 0.0.2  
**æœ€åæ›´æ–°**: 2026-01-14  
**ä½œè€…**: Cursor Helper Team
