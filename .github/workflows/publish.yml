name: Publish to Open VSX Registry

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶ï¼ˆå¦‚ v0.0.3ï¼‰
on:
  push:
    tags:
      - 'v*.*.*'

# æˆäºˆå·¥ä½œæµå¿…è¦çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci
      
      # 4. ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
      - name: Switch to production config
        run: |
          echo "Switching to production configuration..."
          cp src/config.prod.json src/config.json
          cat src/config.json
          echo "Production config applied!"
      
      # 5. ç¼–è¯‘ TypeScript
      - name: Compile TypeScript
        run: npm run compile
      
      # 6. éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
      - name: Verify version
        run: |
          # ä» git tag è·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          # ä» package.json è·å–ç‰ˆæœ¬å·
          PKG_VERSION=$(node -p "require('./package.json').version")
          
          echo "Git tag version: $TAG_VERSION"
          echo "Package.json version: $PKG_VERSION"
          
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "Git tag version ($TAG_VERSION) does not match package.json version ($PKG_VERSION)"
            exit 1
          fi
          
          echo "Version verified: $TAG_VERSION"
      
      # 7. å®‰è£…å‘å¸ƒå·¥å…·
      - name: Install publishing tools
        run: npm install -g @vscode/vsce ovsx
      
      # 8. æ‰“åŒ…æ‰©å±•
      - name: Package extension
        run: vsce package
      
      # 9. å‘å¸ƒåˆ° Open VSX Registry
      - name: Publish to Open VSX
        env:
          OVSX_PAT: ${{ secrets.OVSX_TOKEN }}
        run: ovsx publish *.vsix -p $OVSX_PAT
      
      # 10. åˆ›å»º GitHub Release å¹¶ä¸Šä¼  .vsix æ–‡ä»¶
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.vsix'
          body: |
            ## ğŸ“¦ å‘å¸ƒè¯´æ˜
            
            ç‰ˆæœ¬: ${{ github.ref_name }}
            
            âœ… å·²è‡ªåŠ¨å‘å¸ƒåˆ° [Open VSX Registry](https://open-vsx.org/extension/howell/cursor-assistant)
            
            ### ğŸ“¥ å®‰è£…æ–¹å¼
            
            #### æ–¹å¼ä¸€ï¼šä»åº”ç”¨å¸‚åœºå®‰è£…ï¼ˆæ¨èï¼‰
            åœ¨ Cursor ä¸­æŒ‰ `Ctrl+Shift+X`ï¼Œæœç´¢ "æç¤ºè¯åˆ†äº«åŠ©æ‰‹" æˆ– "cursor-assistant"
            
            #### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å®‰è£… VSIX
            ä¸‹è½½ä¸‹æ–¹çš„ `.vsix` æ–‡ä»¶ï¼Œåœ¨ Cursor ä¸­æŒ‰ `Ctrl+Shift+P`ï¼Œé€‰æ‹© "Extensions: Install from VSIX..."
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            
            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/howelljiang/cursor-helper/blob/main/CHANGELOG.md)
          draft: false
          prerelease: false
