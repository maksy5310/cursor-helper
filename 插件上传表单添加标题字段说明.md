# 插件上传表单添加标题字段实现说明

## 概述

本次修改为 Cursor Helper 插件的上传表单添加了"会话标题"字段,实现从数据库中自动获取会话标题并填充到表单中,用户上传时会将标题一并提交到服务器。

## 修改内容

### 1. 数据模型更新 (`src/models/uploadRecord.ts`)

#### 1.1 更新 `UploadRecord` 接口
添加了 `title` 字段:
```typescript
export interface UploadRecord {
    title: string;                 // 会话标题(1-255字符)
    project_name: string;          // 项目名称(1-255字符)
    uploader_email: string;        // 上传人邮箱(有效邮箱格式)
    upload_time: string;           // 上传时间(ISO 8601格式,不能是未来时间)
    content_format: ContentFormat; // 内容格式(默认'markdown')
    content: string;               // 内容(最大10MB)
}
```

#### 1.2 更新 `ValidationErrors` 接口
添加了 `title` 验证错误字段:
```typescript
export interface ValidationErrors {
    title?: string;                // 标题验证错误
    project_name?: string;          // 项目名称验证错误
    uploader_email?: string;        // 邮箱验证错误
    upload_time?: string;          // 时间验证错误
    content?: string;              // 内容验证错误
}
```

#### 1.3 更新 `UploadFormData` 接口
添加了 `title` 字段:
```typescript
export interface UploadFormData {
    title: string;                 // 会话标题
    project_name: string;          // 项目名称
    uploader_email: string;        // 上传人邮箱
    upload_time: string;           // 上传时间(ISO 8601格式)
    content_format: ContentFormat; // 内容格式
    content: string;               // 内容(从数据库加载的会话内容,可编辑)
    composer_id?: string;           // 会话ID(composerId,用于从数据库加载会话)
    validation_errors?: ValidationErrors; // 验证错误(可选)
}
```

#### 1.4 更新 `UploadResponse` 接口
添加了 `title` 字段:
```typescript
export interface UploadResponse {
    data: {
        id: string;                   // 记录ID(UUID)
        title: string;                // 会话标题
        project_name: string;         // 项目名称
        // ... 其他字段
    };
    message: string;
}
```

#### 1.5 更新 `AutoFillData` 接口
添加了 `title` 字段:
```typescript
export interface AutoFillData {
    email: string | null;
    projectName: string | null;
    title: string | null;  // 会话标题
}
```

#### 1.6 添加 `validateTitle` 函数
```typescript
export function validateTitle(title: string): string | undefined {
    if (!title || title.trim().length === 0) {
        return '会话标题不能为空';
    }
    if (title.length < 1 || title.length > 255) {
        return '会话标题必须为1-255字符';
    }
    return undefined;
}
```

#### 1.7 更新验证函数
- `validateUploadRecord`: 添加了对 `title` 的验证
- `validateUploadFormData`: 更新以包含 `title` 字段

### 2. 上传表单面板更新 (`src/ui/uploadFormPanel.ts`)

#### 2.1 添加 `currentComposerId` 成员变量
```typescript
export class UploadFormPanel implements IUploadFormPanel {
    // ... 其他成员变量
    private currentComposerId: string | undefined;
}
```

#### 2.2 更新 `InitFormMessage` 接口
添加了 `title` 字段:
```typescript
interface InitFormMessage {
    type: 'initForm';
    data: {
        title?: string;
        uploader_email?: string;
        project_name?: string;
        content?: string;
        content_format?: ContentFormat;
        upload_time?: string;
    };
}
```

#### 2.3 修改 `showForm` 方法
- 保存 `currentComposerId` 以便后续使用
- 从数据库获取会话标题:
  ```typescript
  // 获取会话标题
  if (!sessionTitle && this.databaseAccess) {
      const sessionList = await this.databaseAccess.getSessionList();
      const session = sessionList.find(s => s.composerId === composerId);
      if (session) {
          sessionTitle = session.name;
          Logger.info(`Session title loaded: ${sessionTitle}`);
      }
  }
  ```
- 在自动填充数据中包含标题:
  ```typescript
  const formData: Partial<UploadFormData> = {
      ...initialData,
      composer_id: composerId || undefined,
      title: initialData?.title || autoFillData.title || sessionTitle || undefined,
      // ... 其他字段
  };
  ```

#### 2.4 修改 `getAutoFillData` 方法
- 添加 `composerId` 参数
- 从数据库获取会话标题:
  ```typescript
  // 安全地获取会话标题
  if (composerId && this.databaseAccess) {
      try {
          const sessionList = await this.databaseAccess.getSessionList();
          const session = sessionList.find(s => s.composerId === composerId);
          if (session) {
              title = session.name;
              Logger.info('Session title auto-filled from database');
          }
      } catch (error) {
          Logger.warn('Failed to get session title for auto-fill', error as Error);
      }
  }
  ```
- 返回包含 `title` 的对象:
  ```typescript
  return { email, projectName, title };
  ```

#### 2.5 修改 `handleSubmit` 方法
在转换为 `UploadRecord` 时包含 `title`:
```typescript
const record: UploadRecord = {
    title: formData.title,
    project_name: formData.project_name,
    uploader_email: formData.uploader_email,
    upload_time: formData.upload_time,
    content_format: formData.content_format,
    content: formData.content
};
```

#### 2.6 修改 `handleRequestAutoFill` 方法
使用保存的 `currentComposerId`:
```typescript
private async handleRequestAutoFill(): Promise<void> {
    try {
        const autoFillData = await this.getAutoFillData(this.currentComposerId);
        // ...
    } catch (error) {
        // ...
    }
}
```

#### 2.7 更新 HTML 表单
在表单中添加"会话标题"输入框(位于"项目名称"之前):
```html
<div class="field">
    <label>会话标题 *</label>
    <input type="text" id="title" required placeholder="请输入会话标题">
    <span class="error" id="title_error"></span>
</div>
```

#### 2.8 更新 JavaScript 表单处理
- **表单提交**: 在 `formData` 中包含 `title`
  ```javascript
  const formData = {
      title: document.getElementById('title').value,
      project_name: document.getElementById('project_name').value,
      // ... 其他字段
  };
  ```

- **initForm 消息处理**: 自动填充标题
  ```javascript
  if (message.data.title) {
      document.getElementById('title').value = message.data.title;
  }
  ```

- **autoFillData 消息处理**: 填充标题
  ```javascript
  if (message.data.title) {
      document.getElementById('title').value = message.data.title;
  }
  ```

- **clearErrors 函数**: 添加 `'title'` 到错误清除列表

## 功能说明

### 数据流程

1. **加载会话时**:
   - 用户从侧边栏点击某个会话
   - 插件调用 `showForm(composerId, ...)`
   - 系统从数据库的 `composerList` 中查找对应的会话记录
   - 提取 `session.name` 作为会话标题
   - 自动填充到表单的"会话标题"字段

2. **上传时**:
   - 用户点击"上传"按钮
   - 表单数据(包含 `title`)被发送到插件后端
   - 插件构造 `UploadRecord` 对象,包含 `title` 字段
   - 通过 API 提交到服务器

### 自动填充优先级

会话标题的自动填充优先级(从高到低):
1. `initialData.title` - 如果调用时明确指定了标题
2. `autoFillData.title` - 从自动填充数据中获取
3. `sessionTitle` - 从数据库会话列表中加载
4. `undefined` - 如果以上都不可用

### 验证规则

会话标题字段的验证规则:
- **必填**: 不能为空
- **长度**: 1-255 字符
- **错误提示**: 
  - 空值: "会话标题不能为空"
  - 超长: "会话标题必须为1-255字符"

## 数据库来源

会话标题来自 Cursor 数据库中的 `composerData` 表:
- 优先使用 `composer.name` 字段
- 如果 `name` 为空,则使用 `composer.subtitle` 字段
- 如果以上都为空,则生成默认值 `Session ${composerId.substring(0, 8)}`

相关代码位于 `src/dataAccess/databaseAccess.ts` 的 `getSessionList` 方法:
```typescript
name: composer.name || composer.subtitle || `Session ${(composer.composerId || 'unknown').substring(0, 8)}`
```

## 兼容性

- 本次修改向后兼容,不会影响现有功能
- 如果数据库中没有会话信息,标题字段将保持为空,用户需要手动输入
- 服务器端需要相应更新以支持 `title` 字段(已在 `spec-share-server` 中完成)

## 测试建议

1. **基本功能测试**:
   - 从侧边栏点击会话,检查标题是否自动填充
   - 修改标题内容,提交表单,验证服务器是否正确接收

2. **边界情况测试**:
   - 测试没有标题的会话(字段应为空)
   - 测试特别长的标题(应触发验证错误)
   - 测试清空标题后提交(应触发"不能为空"错误)

3. **自动填充测试**:
   - 测试表单重置后,标题是否能重新自动填充
   - 测试切换不同会话,标题是否正确更新

## 相关文件

- `src/models/uploadRecord.ts` - 数据模型定义
- `src/ui/uploadFormPanel.ts` - 上传表单面板实现
- `src/dataAccess/databaseAccess.ts` - 数据库访问(会话列表获取)

## 日期

2026-01-18
